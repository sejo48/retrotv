<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de TV Online (M3U)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Modern Dark Theme --- */<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de TV y Series</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Modern Dark Theme Variables (From Jorge's Code) --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --surface-hover-color: #2a2a2a;
            --primary-accent: #4A90E2; /* Blue accent */
            --primary-accent-hover: #357ABD;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --text-on-accent: #FFFFFF;
            --border-color: #383838;
            --favorite-color: #FFD700; /* Gold for favorite */
            --error-color: #CF6679; /* Red for offline/error */
            --success-color: #2ECC71; /* Green for online */
            --unknown-color: #616161; /* Grey for unknown status */
            --loading-color: var(--primary-accent); /* Color para indicador de carga */
            --border-radius: 8px;
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --header-height: 70px;
            --header-height-mobile: 60px;
        }

        /* --- Global Styles (From Jorge's Code) --- */
        * { box-sizing: border-box; }
        html, body { overflow-x: hidden; }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Add padding top to prevent content from hiding behind fixed header */
            padding-top: var(--header-height);
        }
        @media (max-width: 768px) {
            body {
                padding-top: var(--header-height-mobile);
            }
        }

        /* --- Header Styles (From Jorge's Code - Adjusted for Tabs) --- */
        .main-header { /* Renamed from .header to avoid potential conflicts */
            background-color: var(--surface-color);
            padding: 0 var(--spacing-m);
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            height: var(--header-height);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .main-header img {
            height: 45px; object-fit: contain; flex-shrink: 0;
        }
        #current-channel-title { /* Title specific to M3U8 section */
            color: var(--text-primary); font-size: 1.1em; font-weight: 600;
            margin-left: var(--spacing-l); white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; flex-grow: 1; min-width: 0;
        }
        @media (max-width: 768px) {
            .main-header { height: var(--header-height-mobile); padding: 0 var(--spacing-s); }
            .main-header img { height: 35px; }
             #current-channel-title { margin-left: var(--spacing-m); font-size: 1em;}
        }

        /* --- Tab Navigation Styles (Adapted from Immersive) --- */
        .tab-navigation {
            background-color: var(--surface-color); /* Match header */
            padding: var(--spacing-s) var(--spacing-m);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-button {
            padding: 0.6rem 1.2rem; margin: 0 0.25rem; border-radius: var(--border-radius);
            border: 1px solid transparent; background-color: transparent;
            color: var(--text-secondary); font-weight: 600; cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            background-color: var(--surface-hover-color); color: var(--text-primary);
        }
        .tab-button.active {
            background-color: var(--primary-accent); color: var(--text-on-accent);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-color: var(--primary-accent);
        }
        @media (max-width: 768px) {
             .tab-button { padding: 0.5rem 0.8rem; font-size: 0.9em;}
        }


        /* --- Content Section Styling --- */
        .content-section { display: none; padding: var(--spacing-m); }
        .content-section.active { display: block; }
        /* Remove padding for mobile if sections stack directly */
         @media (max-width: 768px) {
             .content-section { padding: var(--spacing-s); }
         }

        /* --- M3U8 Player Section Styles (From Jorge's Code) --- */
        /* Container for M3U8 player and playlist */
        .m3u8-container {
            display: flex; flex-direction: row;
            max-width: 1600px; margin: 0 auto; /* Centered */
            height: calc(100vh - var(--header-height) - 80px); /* Adjust height considering header and tabs */
            overflow: hidden; gap: var(--spacing-l);
        }
        #player-container { /* M3U8 Video Player */
            flex: 3; position: relative; border-radius: var(--border-radius);
            overflow: hidden; background-color: #000;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border-color);
        }
        #my-video { /* M3U8 Video element */
            width: 100%; height: 100%; object-fit: contain; display: block;
            border-radius: var(--border-radius);
        }
        #playlist-container { /* M3U8 Playlist */
            flex: 1; background-color: var(--surface-color); border-radius: var(--border-radius);
            padding: var(--spacing-m); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; min-width: 300px;
            max-height: 100%; position: relative;
        }
        .playlist-title-container { /* M3U8 Title/Count */
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: var(--spacing-m); padding-bottom: var(--spacing-s);
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        #playlist-container h2 { /* M3U8 "Canales" title */
            margin: 0; font-size: 1.25em; font-weight: 600; color: var(--text-primary);
        }
        #channel-count-container { /* M3U8 Count Bubble */
            width: auto; height: 28px; background-color: var(--primary-accent);
            border-radius: 14px; display: flex; align-items: center; justify-content: center;
            padding: 0 var(--spacing-s); flex-shrink: 0; margin: 0;
        }
        #channel-count-number { /* M3U8 Count Number */
            color: var(--text-on-accent); font-size: 0.8em; font-weight: 600; line-height: 1;
        }
        #search { /* M3U8 Search Input */
            width: 100%; padding: var(--spacing-s) var(--spacing-m); margin-bottom: var(--spacing-m);
            border-radius: var(--border-radius); border: 1px solid var(--border-color);
            background-color: var(--bg-color); color: var(--text-primary);
            font-size: 0.95em; transition: border-color 0.2s ease, box-shadow 0.2s ease;
            flex-shrink: 0;
        }
        #search::placeholder { color: var(--text-secondary); }
        #search:focus {
            outline: none; border-color: var(--primary-accent);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3);
        }
        #playlist { /* M3U8 UL */
            list-style-type: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto;
            /* Custom Scrollbar */
            &::-webkit-scrollbar { width: 8px; }
            &::-webkit-scrollbar-track { background: var(--surface-color); border-radius: 4px; }
            &::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 4px; border: 2px solid var(--surface-color); }
            &::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }
        }
        #playlist li { /* M3U8 LI */
            display: flex; justify-content: space-between; align-items: center;
            cursor: default; padding: var(--spacing-s); margin-bottom: var(--spacing-s);
            background-color: transparent; border-radius: var(--border-radius);
            transition: background-color 0.15s ease-in-out; border: 1px solid transparent;
        }
        #playlist li:hover { background-color: var(--surface-hover-color); }
        #playlist li.active { /* M3U8 Active Channel */
            background-color: rgba(74, 144, 226, 0.15); border: 1px solid var(--primary-accent);
        }
        #playlist li.active .channel-title { color: var(--primary-accent); font-weight: 600; }
        #playlist li.active .channel-desc { color: var(--text-secondary); }
        .channel-button { /* M3U8 Button inside LI */
            background: none; border: none; padding: 0; margin: 0; color: inherit;
            font-family: inherit; font-size: inherit; text-align: left; cursor: pointer;
            display: block; flex-grow: 1; margin-right: var(--spacing-s);
            border-radius: var(--border-radius); overflow: hidden;
        }
        .channel-info { display: flex; align-items: center; gap: var(--spacing-s); overflow: hidden; }
        .status-dot { /* M3U8 Status Dot */
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            background-color: var(--unknown-color); margin-right: var(--spacing-s);
            flex-shrink: 0; transition: background-color 0.3s ease;
        }
        .status-dot.online { background-color: var(--success-color); }
        .status-dot.offline { background-color: var(--error-color); }
        .channel-info img { /* M3U8 Logo */
            width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
            object-fit: cover; border: 1px solid var(--border-color);
            background-color: var(--border-color);
        }
        .channel-details { overflow: hidden; display: flex; flex-direction: column; }
        .channel-title { /* M3U8 Channel Title */
            font-size: 0.9em; font-weight: 500; color: var(--text-primary); display: block;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.4;
            transition: color 0.15s ease-in-out;
        }
        .channel-desc { /* M3U8 Channel Desc */
            font-size: 0.8em; color: var(--text-secondary); margin: 2px 0 0 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: color 0.15s ease-in-out;
        }
        #playlist li:has(.channel-button:focus-visible) { /* M3U8 Focus */
            box-shadow: 0 0 0 2px var(--primary-accent); background-color: var(--surface-hover-color);
        }
        .star { /* M3U8 Favorite Star */
            cursor: pointer; color: var(--text-secondary); transition: color 0.2s ease, transform 0.2s ease;
            font-size: 1em; flex-shrink: 0; padding: var(--spacing-xs); line-height: 1;
            margin-right: var(--spacing-xs);
        }
        .star:hover { transform: scale(1.15); color: var(--text-primary); }
        .star.favorite { color: var(--favorite-color); }
        .star.favorite:hover { filter: brightness(1.1); }
        .loading-indicator { /* M3U8 Loading */
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 1em; color: var(--text-secondary); display: none;
            flex-direction: column; align-items: center; gap: var(--spacing-s);
        }
        .loading-indicator.show { display: flex; }
        .spinner { /* M3U8 Spinner */
            border: 4px solid var(--surface-hover-color); border-top: 4px solid var(--loading-color);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* M3U8 Mobile Styles */
        @media (max-width: 768px) {
            .m3u8-container {
                flex-direction: column; height: auto; /* Let content define height */
                min-height: calc(100vh - var(--header-height-mobile) - 60px); /* Approx height */
                gap: 0;
            }
            #player-container { flex: none; height: 40vh; width: 100%; margin: 0; border-radius: 0; border: none; border-bottom: 1px solid var(--border-color); }
            #my-video { border-radius: 0; }
            #playlist-container {
                flex-grow: 1; width: 100%; border-radius: 0; padding: var(--spacing-m); border: none;
                min-height: calc(60vh - 60px); /* Approx height */
                max-height: none; overflow-y: auto; min-width: unset;
            }
            .playlist-title-container { padding-bottom: var(--spacing-s); margin-bottom: var(--spacing-m); }
            #playlist-container h2 { font-size: 1.1em; }
            #channel-count-container { height: 24px; padding: 0 6px; border-radius: 12px; }
            #channel-count-number { font-size: 0.75em; }
            #search { padding: 10px; font-size: 1em; }
            #playlist li { padding: 10px; margin-bottom: 6px; }
            .status-dot { width: 7px; height: 7px; margin-right: 6px; }
            .channel-info img { width: 30px; height: 30px; }
            .channel-title { font-size: 0.9em; }
            .channel-desc { font-size: 0.75em; }
            .star { font-size: 1em; margin-right: var(--spacing-xs); }
        }

        /* --- Series Section Styles (Adapted from Immersive, using CSS Variables) --- */
        .series-list-item { /* Series List Item */
            display: flex; align-items: center; padding: var(--spacing-m); margin-bottom: var(--spacing-s);
            border-radius: var(--border-radius); background-color: var(--surface-color);
            border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s ease;
        }
        .series-list-item:hover {
            background-color: var(--surface-hover-color); border-color: var(--text-secondary);
            transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .series-list-item img { /* Series Poster */
            width: 50px; height: 70px; object-fit: cover; border-radius: calc(var(--border-radius) / 2);
            margin-right: var(--spacing-m); background-color: var(--border-color);
        }
        .series-list-item .text-content { flex-grow: 1; overflow: hidden; }
        .series-list-item h3 { /* Series Title in List */
            font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .series-list-item p { /* Series Desc in List */
            font-size: 0.875em; color: var(--text-secondary); line-height: 1.4;
            /* Limit description lines shown in list */
             display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        #seriesDetailContainer h3 { /* Series Title in Detail */
            font-size: 1.5em; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-s);
        }
        #seriesDetailContainer .description { /* Series Desc in Detail */
            color: var(--text-secondary); margin-bottom: var(--spacing-l); font-size: 0.95em;
        }
        .episode-list-item { /* Episode Item */
            padding: var(--spacing-s) var(--spacing-m); margin-bottom: var(--spacing-s);
            border-radius: var(--border-radius); background-color: var(--surface-hover-color);
            cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.95em; color: var(--text-secondary); border: 1px solid var(--border-color);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .episode-list-item:hover { background-color: var(--surface-color); color: var(--text-primary); }
        .episode-list-item.playing { /* Active Episode */
            background-color: var(--primary-accent); color: var(--text-on-accent);
            font-weight: 600; border-color: var(--primary-accent-hover);
        }
        .back-button { /* Series Back Button */
            background-color: var(--text-secondary); color: var(--bg-color);
            padding: var(--spacing-s) var(--spacing-m); border: none; border-radius: var(--border-radius);
            cursor: pointer; margin-bottom: var(--spacing-l); transition: background-color 0.2s ease;
            font-weight: 600; display: inline-block;
        }
        .back-button:hover { background-color: var(--text-primary); }
        .video-container { /* Series Video Container (iframe) */
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
            max-width: 100%; background: #000; border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); margin-bottom: var(--spacing-l);
            border: 1px solid var(--border-color);
        }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .video-container .message { /* Message inside Series player */
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-secondary); text-align: center; padding: var(--spacing-m);
        }
         #episodeList { /* Container for episode list items */
             max-height: 300px; /* Limit height and allow scroll */
             overflow-y: auto;
             padding-right: var(--spacing-xs); /* Space for scrollbar */
             /* Custom Scrollbar for episode list */
             &::-webkit-scrollbar { width: 6px; }
             &::-webkit-scrollbar-track { background: var(--surface-color); border-radius: 3px; }
             &::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
             &::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }
         }

        /* --- Error Overlay Styles (From Jorge's Code) --- */
        .error-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000;
            color: var(--text-primary); text-align: center; padding: var(--spacing-l);
            display: none; /* Hidden by default */
        }
        .error-message {
            font-size: 1.2em; margin-bottom: var(--spacing-l); color: var(--error-color);
        }
        .error-buttons { display: flex; gap: var(--spacing-m); }
        .error-button {
            padding: var(--spacing-s) var(--spacing-l); background-color: var(--primary-accent);
            border: none; border-radius: var(--border-radius); color: var(--text-on-accent);
            cursor: pointer; transition: background-color 0.2s ease; font-size: 0.95em; font-weight: 600;
        }
        .error-button:hover { background-color: var(--primary-accent-hover); }
        .error-button:focus-visible { outline: 2px solid var(--text-on-accent); outline-offset: 2px; }

    </style>
</head>
<body>
    <header class="main-header">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgVIFxWI-sdOR2bVfpbgCotXquColWskv4u4I9HXZhYdsRewDVRNcJ7iLvtKO2xYucvqOv0DKY2MArMnHGF8IvZBI7NYjg0dkjHUN0N8VXwZ73vKjYOajWC6JTze5n1Hcj19V2COVFkN-TtJA7uR_ALIYyIcvUBOwQN1EmURskiBCI_lJK3hFphdSBuCaQ/s320/logo%20(%20JORGEDEZ%20)%20ROJO%20Y%20BLANCO%20PARA%20VIDEO.jpeg" alt="JORGEDEZ Logo">
        <span id="current-channel-title">Cargando...</span>
    </header>

    <div class="tab-navigation">
        <button id="tvButton" class="tab-button active">TV en Vivo</button>
        <button id="seriesButton" class="tab-button">Series</button>
    </div>

    <div id="main-content-area">
        <section id="tvSection" class="content-section active">
            <div class="m3u8-container">
                <div id="player-container">
                    <video id="my-video" controls playsinline webkit-playsinline crossorigin="anonymous">
                        Tu navegador no soporta el elemento de video.
                    </video>
                </div>
                <div id="playlist-container">
                    <div class="loading-indicator" id="loading-indicator">
                        <div class="spinner"></div>
                        <span>Cargando canales...</span>
                    </div>
                    <div class="playlist-title-container">
                        <h2>Canales</h2>
                        <div id="channel-count-container" aria-live="polite" aria-atomic="true">
                            <span id="channel-count-number">0</span>
                        </div>
                    </div>
                    <input type="text" id="search" placeholder="Buscar canal..." aria-label="Buscar canal" disabled>
                    <ul id="playlist" aria-label="Lista de canales">
                        </ul>
                </div>
            </div>
        </section>

        <section id="seriesSection" class="content-section">
            <div id="seriesListContainer">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center" style="color: var(--text-primary);">Catálogo de Series</h2>
                <div id="seriesList" class="space-y-3">
                    <p class="text-center" style="color: var(--text-secondary);">Cargando series...</p>
                </div>
            </div>

            <div id="seriesDetailContainer" style="display: none;">
                <button id="backButton" class="back-button">&larr; Volver a Series</button>
                <h3 id="seriesDetailTitle" class="text-center mb-2"></h3>
                <p id="seriesDetailDescription" class="description text-center text-sm mb-6"></p>

                <div class="video-container">
                    <iframe id="drivePlayer" src="" allow="autoplay; fullscreen" allowfullscreen></iframe>
                     <div id="drivePlayerMessage" class="message" style="display: none;">Selecciona un episodio</div>
                     </div>

                <h4 class="text-lg font-semibold mb-3" style="color: var(--text-secondary);">Episodios:</h4>
                <div id="episodeList">
                    </div>
            </div>
        </section>
    </div>

    <div class="error-overlay" id="error-overlay" role="alertdialog" aria-labelledby="error-message" aria-modal="true">
        <div class="error-message" id="error-message">No se pudo cargar el canal. Intente con otro.</div>
        <div class="error-buttons">
            <button class="error-button" id="try-again-button">Intentar nuevamente</button>
            <button class="error-button" id="try-another-button">Probar otro canal</button>
            <button class="error-button" id="reload-list-button">Recargar Lista M3U</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Tab Navigation Logic ---
            const tvButton = document.getElementById('tvButton');
            const seriesButton = document.getElementById('seriesButton');
            const tvSection = document.getElementById('tvSection');
            const seriesSection = document.getElementById('seriesSection');
            const contentSections = document.querySelectorAll('.content-section');
            const tabButtons = document.querySelectorAll('.tab-button');
            const m3u8VideoPlayer = document.getElementById('my-video'); // M3U8 <video> element
            const driveIframePlayer = document.getElementById('drivePlayer'); // Drive <iframe> element

            function showSection(sectionIdToShow) {
                let isSwitchingToSeries = sectionIdToShow === 'seriesSection';
                let isSwitchingToTv = sectionIdToShow === 'tvSection';

                 // Pause videos before switching
                 if (isSwitchingToSeries && m3u8VideoPlayer && !m3u8VideoPlayer.paused) {
                     console.log("Pausing M3U8 player");
                     m3u8VideoPlayer.pause();
                     // Optional: Destroy HLS instance if needed to save resources
                     // if (hls) { hls.destroy(); hls = null; }
                 } else if (isSwitchingToTv && driveIframePlayer) {
                     console.log("Resetting Drive player");
                     driveIframePlayer.src = 'about:blank'; // Reset iframe src to stop playback
                 }


                contentSections.forEach(section => section.classList.remove('active'));
                tabButtons.forEach(button => button.classList.remove('active'));

                const sectionToShowElement = document.getElementById(sectionIdToShow);
                const buttonToActivate = document.getElementById(sectionIdToShow.replace('Section', 'Button'));

                if (sectionToShowElement) sectionToShowElement.classList.add('active');
                if (buttonToActivate) buttonToActivate.classList.add('active');

                // Update header title based on active section
                 const headerTitle = document.getElementById('current-channel-title');
                 if (headerTitle) {
                     if (isSwitchingToTv) {
                         // Restore M3U8 title (might need adjustment based on M3U8 logic state)
                         headerTitle.textContent = m3u8Logic.getCurrentChannelTitle() || 'Canales de TV';
                     } else if (isSwitchingToSeries) {
                         headerTitle.textContent = 'Series'; // Set a generic title for Series section
                     }
                 }


                // If switching to Series and data hasn't been loaded, load it
                if (isSwitchingToSeries && seriesLogic.allSeriesData.length === 0) {
                    seriesLogic.fetchSeriesData();
                }
                 // If switching to TV and M3U8 list hasn't loaded, load it (handled by m3u8Logic.initializeApp)
                 // Maybe trigger re-render or check state if needed
            }

            tvButton.addEventListener('click', () => showSection('tvSection'));
            seriesButton.addEventListener('click', () => showSection('seriesSection'));

             // --- M3U8 Player Logic (From Jorge's Code, Wrapped in an Object/Namespace) ---
             const m3u8Logic = (() => {
                 // --- !!! IMPORTANTE: URL de tu archivo M3U !!! ---
                 const m3uUrl = 'https://raw.githubusercontent.com/sejo48/chanejorgedez/refs/heads/main/listaoficial.m3u';

                 // --- Global Channel Array ---
                 let channels = [];
                 const STATUS_STORAGE_KEY = 'channelStatusesTvPlayer';
                 let channelStatuses = JSON.parse(localStorage.getItem(STATUS_STORAGE_KEY)) || {};

                 // --- DOM Elements (Scoped to M3U8 section) ---
                 const videoPlayer = document.getElementById('my-video');
                 const playlist = document.getElementById('playlist');
                 const searchInput = document.getElementById('search');
                 const playerContainer = document.getElementById('player-container');
                 const playlistContainer = document.getElementById('playlist-container');
                 const errorOverlay = document.getElementById('error-overlay');
                 const errorMessage = document.getElementById('error-message');
                 const tryAgainButton = document.getElementById('try-again-button');
                 const tryAnotherButton = document.getElementById('try-another-button');
                 const reloadListButton = document.getElementById('reload-list-button');
                 const currentChannelTitleElement = document.getElementById('current-channel-title'); // Header title
                 const countContainer = document.getElementById('channel-count-container');
                 const countSpan = document.getElementById('channel-count-number');
                 const loadingIndicator = document.getElementById('loading-indicator');

                 // --- State Variables ---
                 let favorites = JSON.parse(localStorage.getItem('favoritesTvChannels')) || [];
                 let lastAttemptedChannel = null;
                 let hls = null;
                 let currentChannelIndex = null;
                 let videoPlayingListener = null;

                 // --- Show/Hide Loading Indicator ---
                 function showLoading(message = "Cargando canales...") {
                     if (loadingIndicator) {
                         loadingIndicator.querySelector('span').textContent = message;
                         loadingIndicator.classList.add('show');
                     }
                     if(searchInput) searchInput.disabled = true;
                     if(playlist) playlist.innerHTML = '';
                     if (countSpan) countSpan.textContent = '...';
                 }

                 function hideLoading() {
                     if (loadingIndicator) {
                         loadingIndicator.classList.remove('show');
                     }
                      if(searchInput) searchInput.disabled = false;
                 }

                 // --- M3U Parsing Function ---
                 async function fetchAndParseM3U(url) {
                    showLoading();
                    console.log(`Fetching M3U from: ${url}`);
                    try {
                        const response = await fetch(url, { cache: "no-store" }); // Prevent caching M3U
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const m3uText = await response.text();
                        console.log("M3U content fetched successfully.");

                        const lines = m3uText.split(/[\r\n]+/);
                        const parsedChannels = [];
                        let currentChannelInfo = null;
                        const extinfRegex = /#EXTINF:(-?\d+)(.*)/;
                        const attributeRegex = /(\S+?)=(?:"([^"]*)"|([^ ]*))/g;
                        const titleCommaRegex = /,(?!")(.*)/;

                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            if (!trimmedLine || trimmedLine === '#EXTM3U') continue;

                            if (trimmedLine.startsWith('#EXTINF:')) {
                                const match = trimmedLine.match(extinfRegex);
                                if (match) {
                                    currentChannelInfo = { duration: match[1], attributes: {}, title: '', logo: '', url: '', descripcion: '' };
                                    const restOfLine = match[2] || '';
                                    let attrMatch;
                                    while ((attrMatch = attributeRegex.exec(restOfLine)) !== null) {
                                        const key = attrMatch[1].toLowerCase();
                                        const value = attrMatch[2] !== undefined ? attrMatch[2] : attrMatch[3];
                                        currentChannelInfo.attributes[key] = value;
                                    }
                                    currentChannelInfo.title = (currentChannelInfo.attributes['tvg-name'] || '').trim();
                                    if (!currentChannelInfo.title) {
                                        const titleMatch = restOfLine.match(titleCommaRegex);
                                        if (titleMatch && titleMatch[1]) {
                                            currentChannelInfo.title = titleMatch[1].trim();
                                        }
                                    }
                                    if (!currentChannelInfo.title) { currentChannelInfo.title = 'Sin Título'; }
                                    currentChannelInfo.logo = currentChannelInfo.attributes['tvg-logo'] || '';
                                    currentChannelInfo.descripcion = `Canal: ${currentChannelInfo.title}`;
                                } else {
                                    console.warn("Línea #EXTINF no reconocida:", trimmedLine);
                                    currentChannelInfo = null;
                                }
                            } else if (currentChannelInfo && !trimmedLine.startsWith('#')) {
                                currentChannelInfo.url = trimmedLine;
                                if (currentChannelInfo.url) {
                                    parsedChannels.push(currentChannelInfo);
                                } else {
                                    console.warn("Skipping channel entry with missing URL:", currentChannelInfo.title);
                                }
                                currentChannelInfo = null;
                            }
                        }
                        console.log(`Parsed ${parsedChannels.length} channels.`);
                        if (parsedChannels.length === 0 && lines.length > 1) {
                            showM3UError("No se encontraron canales válidos en el archivo M3U.");
                            return [];
                        }
                        return parsedChannels;
                    } catch (error) {
                        console.error('Error fetching or parsing M3U:', error);
                        showM3UError(`Error al cargar la lista M3U: ${error.message}. Verifica la URL e inténtalo de nuevo.`);
                        return [];
                    } finally {
                        hideLoading();
                    }
                 }

                 // --- Show M3U Loading Error ---
                 function showM3UError(message) {
                     if(errorMessage) errorMessage.textContent = message;
                     if(errorOverlay) errorOverlay.style.display = 'flex';
                     if(tryAgainButton) tryAgainButton.style.display = 'none';
                     if(tryAnotherButton) tryAnotherButton.style.display = 'none';
                     if(reloadListButton) reloadListButton.style.display = 'inline-block';
                 }

                 // --- Update Status ---
                 function updateChannelStatus(index, status) {
                     if (index === null || index < 0 || index >= channels.length) return;
                     channelStatuses[index] = status;
                     localStorage.setItem(STATUS_STORAGE_KEY, JSON.stringify(channelStatuses));
                     const listItem = playlist?.querySelector(`li[data-original-index="${index}"]`);
                     if (listItem) {
                         const dot = listItem.querySelector('.status-dot');
                         if (dot) {
                             dot.className = 'status-dot'; // Reset classes
                             let statusTitle = 'Desconocido';
                             if (status === 'online') { dot.classList.add('online'); statusTitle = 'En línea'; }
                             else if (status === 'offline') { dot.classList.add('offline'); statusTitle = 'Fuera de línea'; }
                             dot.title = `Estado: ${statusTitle}`;
                         }
                     }
                 }

                 // --- Show Playback Error ---
                 function showError(message, channelIndex) {
                     console.error("Playback Error:", message, "Channel Index:", channelIndex);
                     lastAttemptedChannel = channelIndex;
                     if(errorMessage) errorMessage.textContent = message;
                     if(errorOverlay) errorOverlay.style.display = 'flex';
                     if(tryAgainButton) tryAgainButton.style.display = 'inline-block';
                     if(tryAnotherButton) tryAnotherButton.style.display = 'inline-block';
                     if(reloadListButton) reloadListButton.style.display = 'none';

                     if (hls) { hls.destroy(); hls = null; }
                     if(videoPlayer) {
                         videoPlayer.pause();
                         videoPlayer.removeAttribute('src');
                         videoPlayer.load();
                     }
                     if (currentChannelTitleElement) currentChannelTitleElement.textContent = 'Error al cargar';
                     if (channelIndex !== null && channelIndex < channels.length) {
                         updateChannelStatus(channelIndex, 'offline');
                     }
                 }

                 function hideError() {
                     if(errorOverlay) errorOverlay.style.display = 'none';
                 }

                 // --- Event Listeners for Error Buttons ---
                 if(tryAgainButton) tryAgainButton.addEventListener('click', () => {
                     hideError();
                     if (lastAttemptedChannel !== null && lastAttemptedChannel >= 0 && lastAttemptedChannel < channels.length) {
                         selectChannel(lastAttemptedChannel);
                     }
                 });
                 if(tryAnotherButton) tryAnotherButton.addEventListener('click', hideError);
                 if(reloadListButton) reloadListButton.addEventListener('click', () => {
                     hideError();
                     initializeApp();
                 });

                 // --- Playlist Rendering ---
                 function renderPlaylist(channelsToRender = channels) {
                     if (!playlist) return;
                     playlist.innerHTML = '';
                     if (!channelsToRender || channelsToRender.length === 0) {
                         if (countSpan) countSpan.textContent = '0';
                         if (currentChannelTitleElement && tvSection.classList.contains('active')) currentChannelTitleElement.textContent = 'No hay canales';
                         playlist.innerHTML = '<li style="color: var(--text-secondary); text-align: center; margin-top: var(--spacing-l);">No hay canales para mostrar.</li>';
                         return;
                     }
                     if (countSpan) countSpan.textContent = channelsToRender.length;

                     const sortedChannels = [...channelsToRender].sort((a, b) => {
                         const aIndex = channels.findIndex(ch => ch.url === a.url);
                         const bIndex = channels.findIndex(ch => ch.url === b.url);
                         const aIsFavorite = favorites.includes(aIndex.toString());
                         const bIsFavorite = favorites.includes(bIndex.toString());
                         if (aIsFavorite && !bIsFavorite) return -1;
                         if (!aIsFavorite && bIsFavorite) return 1;
                         return (a.title || '').localeCompare(b.title || '');
                     });

                     sortedChannels.forEach((channel) => {
                         const originalIndex = channels.findIndex(ch => ch.url === channel.url);
                         if (originalIndex === -1) return;
                         const li = document.createElement('li');
                         li.dataset.originalIndex = originalIndex;
                         const channelButton = document.createElement('button');
                         channelButton.className = 'channel-button';
                         channelButton.type = 'button';
                         channelButton.setAttribute('aria-label', `Reproducir ${channel.title || 'Canal sin título'}`);
                         const currentStatus = channelStatuses[originalIndex];
                         const statusTitle = currentStatus === 'online' ? 'En línea' : currentStatus === 'offline' ? 'Fuera de línea' : 'Desconocido';
                         const logoSrc = channel.logo || `https://placehold.co/32x32/383838/A0A0A0?text=${encodeURIComponent((channel.title || '?').charAt(0))}`;
                         const logoAlt = channel.logo ? '' : `${channel.title || 'Canal'} Placeholder`;

                         channelButton.innerHTML = `
                             <div class="channel-info">
                                 <span class="status-dot ${currentStatus || ''}" title="Estado: ${statusTitle}"></span>
                                 <img src="${logoSrc}" alt="${logoAlt}" onerror="this.onerror=null; this.src='https://placehold.co/32x32/383838/A0A0A0?text=${encodeURIComponent((channel.title || '?').charAt(0))}'; this.alt='${channel.title || 'Canal'} Placeholder';" loading="lazy">
                                 <div class="channel-details">
                                     <span class="channel-title">${channel.title || 'Canal sin título'}</span>
                                     <p class="channel-desc">${channel.descripcion || 'Sin descripción'}</p>
                                 </div>
                             </div>`;
                         channelButton.addEventListener('click', () => selectChannel(originalIndex));
                         li.appendChild(channelButton);

                         const star = document.createElement('i');
                         const isFavorite = favorites.includes(originalIndex.toString());
                         star.className = `star fas fa-star ${isFavorite ? 'favorite' : ''}`;
                         star.dataset.index = originalIndex;
                         star.setAttribute('role', 'button');
                         star.setAttribute('aria-pressed', isFavorite.toString());
                         star.setAttribute('aria-label', isFavorite ? `Quitar ${channel.title || 'Canal'} de favoritos` : `Añadir ${channel.title || 'Canal'} a favoritos`);
                         star.tabIndex = 0;
                         star.addEventListener('click', (e) => { e.stopPropagation(); toggleFavorite(originalIndex.toString()); rerenderCurrentList(); });
                         star.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); e.stopPropagation(); toggleFavorite(originalIndex.toString()); rerenderCurrentList(); } });
                         li.appendChild(star);
                         playlist.appendChild(li);
                     });
                     if (currentChannelIndex !== null && currentChannelIndex < channels.length) {
                         setActiveChannelHighlight(currentChannelIndex);
                     }
                 }

                 // --- Rerender current list (after favorite toggle) ---
                 function rerenderCurrentList() {
                     const currentSearchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                     renderPlaylist(currentSearchTerm ? filterChannels(currentSearchTerm) : channels);
                 }


                 // --- Filter Channels ---
                 function filterChannels(searchTerm) {
                     if (!channels || channels.length === 0) return [];
                     return channels.filter(ch =>
                         (ch.title && ch.title.toLowerCase().includes(searchTerm)) ||
                         (ch.descripcion && ch.descripcion.toLowerCase().includes(searchTerm))
                     );
                 }

                 // --- Set Active Channel Highlight ---
                 function setActiveChannelHighlight(index) {
                    if (index === null || !playlist) return;
                    document.querySelectorAll('#playlist li').forEach(item => item.classList.remove('active'));
                    const activeListItem = playlist.querySelector(`li[data-original-index="${index}"]`);
                    if (activeListItem) activeListItem.classList.add('active');
                 }

                 // --- Select Channel ---
                 function selectChannel(index) {
                     if (index === null || index < 0 || index >= channels.length) {
                         showError("Índice de canal inválido.", index); return;
                     }
                     hideError();
                     const channel = channels[index];
                     console.log(`Selecting M3U8 channel ${index}: ${channel.title}`);
                     if (currentChannelTitleElement && tvSection.classList.contains('active')) { // Only update if TV section is active
                         currentChannelTitleElement.textContent = channel.title || 'Canal sin título';
                         currentChannelTitleElement.title = channel.title || 'Canal sin título';
                     }
                     playVideo(channel.url, index);
                     scrollToPlayer();
                     localStorage.setItem('lastPlayedTvChannel', index.toString());
                     currentChannelIndex = index;
                     setActiveChannelHighlight(index);
                 }

                 // --- Play Video (HLS Handling) ---
                 function playVideo(url, channelIndex) {
                     console.log(`Attempting M3U8 playback: ${url}`);
                     lastAttemptedChannel = channelIndex;
                     if (!url || typeof url !== 'string' || url.trim() === '') {
                         showError("URL del canal inválida.", channelIndex); return;
                     }
                     if (hls) { hls.destroy(); hls = null; }
                     if (!videoPlayer) { showError("Error interno: Reproductor no encontrado.", channelIndex); return; }

                     videoPlayer.removeAttribute('src');
                     videoPlayer.load(); // Reset player state
                     videoPlayer.removeEventListener('error', handleVideoElementError);
                     if (videoPlayingListener) { videoPlayer.removeEventListener('playing', videoPlayingListener); videoPlayingListener = null; }

                     const isM3U8 = url.includes('.m3u8') || url.includes('mpegurl');
                     const handlePlaying = () => {
                         if (lastAttemptedChannel === channelIndex) {
                             updateChannelStatus(channelIndex, 'online');
                         }
                     };
                     videoPlayingListener = handlePlaying; // Store reference to remove later

                     if (Hls.isSupported() && isM3U8) {
                         console.log("Using HLS.js");
                         hls = new Hls({ /* HLS config if needed */ });
                         hls.on(Hls.Events.ERROR, (event, data) => {
                             console.error('HLS Error:', event, data);
                             if (data.fatal && lastAttemptedChannel === channelIndex) { // Check if error belongs to current attempt
                                 let errorMsg = `Error HLS (${data.details}).`;
                                 if (data.type === Hls.ErrorTypes.NETWORK_ERROR) errorMsg = `Error de red (${data.details}).`;
                                 else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) errorMsg = `Error en datos del video (${data.details}).`;
                                 showError(errorMsg, channelIndex);
                             }
                         });
                         hls.loadSource(url);
                         hls.attachMedia(videoPlayer);
                         hls.on(Hls.Events.MANIFEST_PARSED, () => {
                             videoPlayer.play().catch(e => console.error("Error starting HLS playback:", e));
                         });
                         videoPlayer.addEventListener('playing', videoPlayingListener, { once: true });
                     } else if (isM3U8 && videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                         console.log("Using native HLS");
                         videoPlayer.src = url;
                         videoPlayer.addEventListener('error', handleVideoElementError);
                         videoPlayer.addEventListener('loadedmetadata', () => videoPlayer.play().catch(e => console.error("Error starting native HLS playback:", e)), { once: true });
                         videoPlayer.addEventListener('playing', videoPlayingListener, { once: true });
                     } else {
                         if (!isM3U8) {
                             console.log("Attempting direct playback");
                             videoPlayer.src = url;
                             videoPlayer.addEventListener('error', handleVideoElementError);
                             videoPlayer.addEventListener('loadeddata', () => videoPlayer.play().catch(e => console.error("Error starting direct playback:", e)), { once: true });
                             videoPlayer.addEventListener('playing', videoPlayingListener, { once: true });
                         } else {
                             showError("Formato M3U8 no soportado por este navegador.", channelIndex);
                         }
                     }
                 }

                 // --- Native Video Element Error Handler ---
                 function handleVideoElementError() {
                     const error = videoPlayer.error;
                     if (!error || lastAttemptedChannel === null) return; // Don't show error if no channel was attempted
                     console.error("Native <video> Error:", error);
                     let message = "Error desconocido.";
                     if (error) {
                         switch (error.code) {
                             case error.MEDIA_ERR_ABORTED: message = 'Carga abortada.'; break;
                             case error.MEDIA_ERR_NETWORK: message = 'Error de red.'; break;
                             case error.MEDIA_ERR_DECODE: message = 'Error de decodificación.'; break;
                             case error.MEDIA_ERR_SRC_NOT_SUPPORTED: message = 'Formato no soportado o URL inválida.'; break;
                             default: message = `Error ${error.code}.`; break;
                         }
                     }
                     // Only show error if it corresponds to the last channel attempt
                     if (lastAttemptedChannel !== null) {
                         showError(message, lastAttemptedChannel);
                     }
                     videoPlayer.removeEventListener('error', handleVideoElementError); // Remove listener after firing
                 }

                 // --- Scroll To Player ---
                 function scrollToPlayer() {
                     if (window.innerWidth <= 768 && playerContainer) {
                         playerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                     }
                 }

                 // --- Toggle Favorite ---
                 function toggleFavorite(indexString) {
                     const index = parseInt(indexString);
                     if (isNaN(index)) return;
                     const indexInFavorites = favorites.indexOf(indexString);
                     if (indexInFavorites > -1) favorites.splice(indexInFavorites, 1);
                     else favorites.push(indexString);
                     localStorage.setItem('favoritesTvChannels', JSON.stringify(favorites));
                     // Re-rendering is handled by the caller (renderPlaylist or rerenderCurrentList)
                 }

                 // --- Search Input Listener ---
                 if(searchInput) searchInput.addEventListener('input', () => {
                     const searchTerm = searchInput.value.toLowerCase().trim();
                     renderPlaylist(filterChannels(searchTerm));
                 });

                 // --- Initialization ---
                 async function initializeApp() {
                     channels = await fetchAndParseM3U(m3uUrl);
                     renderPlaylist();
                     if (channels.length > 0) {
                         const lastPlayedIndexStr = localStorage.getItem('lastPlayedTvChannel');
                         let initialChannelIndex = 0;
                         if (lastPlayedIndexStr !== null) {
                             const lastPlayedIndex = parseInt(lastPlayedIndexStr);
                             if (!isNaN(lastPlayedIndex) && lastPlayedIndex >= 0 && lastPlayedIndex < channels.length) {
                                 initialChannelIndex = lastPlayedIndex;
                             } else { localStorage.removeItem('lastPlayedTvChannel'); }
                         }
                         currentChannelIndex = initialChannelIndex; // Set initial index
                         // Set initial header title ONLY if TV section is active
                         if (tvSection.classList.contains('active') && currentChannelTitleElement) {
                             currentChannelTitleElement.textContent = channels[initialChannelIndex].title || 'Canal sin título';
                             currentChannelTitleElement.title = channels[initialChannelIndex].title || 'Canal sin título';
                         }
                         setActiveChannelHighlight(initialChannelIndex); // Highlight but don't auto-play
                     } else {
                          if (currentChannelTitleElement && tvSection.classList.contains('active')) currentChannelTitleElement.textContent = 'Error al cargar lista';
                     }
                 }

                 // --- Public Methods/Properties (Optional) ---
                 return {
                     initializeApp,
                     getCurrentChannelTitle: () => {
                         if (currentChannelIndex !== null && currentChannelIndex >= 0 && currentChannelIndex < channels.length) {
                             return channels[currentChannelIndex].title || 'Canal sin título';
                         }
                         return null; // Or a default title
                     },
                     pauseVideo: () => {
                         if (videoPlayer && !videoPlayer.paused) videoPlayer.pause();
                     }
                     // Add other methods if needed for external control
                 };
             })(); // End m3u8Logic IIFE

             // --- Series Player Logic (Adapted from Immersive, Wrapped in Namespace) ---
             const seriesLogic = (() => {
                 // --- DOM Elements (Scoped to Series section) ---
                 const listContainer = document.getElementById('seriesListContainer');
                 const detailContainer = document.getElementById('seriesDetailContainer');
                 const listDiv = document.getElementById('seriesList');
                 const detailTitle = document.getElementById('seriesDetailTitle');
                 const detailDescription = document.getElementById('seriesDetailDescription');
                 const episodeListDiv = document.getElementById('episodeList');
                 const iframePlayer = document.getElementById('drivePlayer'); // Reference the iframe
                 const playerMessage = document.getElementById('drivePlayerMessage'); // Reference the message div for iframe
                 const backBtn = document.getElementById('backButton');

                 // --- State ---
                 let allSeriesData = [];
                 let currentSeriesIndex = -1;
                 const placeholderImage = "https://placehold.co/50x70/1e1e1e/A0A0A0?text=Serie"; // Dark theme placeholder

                 // --- Event Listener for Back Button ---
                 if(backBtn) backBtn.addEventListener('click', showSeriesListView);

                 // --- View Switching ---
                 function showSeriesListView() {
                     if(listContainer) listContainer.style.display = 'block';
                     if(detailContainer) detailContainer.style.display = 'none';
                     if(iframePlayer) iframePlayer.src = 'about:blank'; // Stop video when going back
                 }
                 function showSeriesDetailView() {
                     if(listContainer) listContainer.style.display = 'none';
                     if(detailContainer) detailContainer.style.display = 'block';
                 }

                 // --- Data Fetching ---
                 async function fetchSeriesData() {
                     const playlistUrl = "https://raw.githubusercontent.com/sejo48/jorgedrive/refs/heads/main/playlist.json"; // Your JSON URL
                     if (!listDiv) return; // Don't fetch if the element doesn't exist
                     listDiv.innerHTML = `<p class="text-center" style="color: var(--text-secondary);">Cargando series...</p>`;
                     try {
                         const response = await fetch(playlistUrl, { cache: "no-store", headers: { 'Accept': 'application/json' } });
                         if (!response.ok) throw new Error(`Error HTTP ${response.status}`);
                         const data = await response.json();
                         if (!Array.isArray(data)) throw new Error("El JSON no es un array.");
                         // Basic validation of structure
                         if (data.length > 0 && (!data[0].tituloSerie || !data[0].episodios)) {
                             console.warn("JSON structure might be incorrect. Expected 'tituloSerie' and 'episodios'.");
                             // Optionally throw error or try to adapt
                         }
                         seriesLogic.allSeriesData = data; // Store data in the namespace
                         displaySeriesList(seriesLogic.allSeriesData);
                     } catch (error) {
                         console.error("Error fetching/processing Series playlist:", error);
                         listDiv.innerHTML = `<p class="text-center" style="color: var(--error-color);">Error al cargar series: ${error.message}</p>`;
                     }
                 }

                 // --- Display Series List ---
                 function displaySeriesList(seriesArray) {
                    if (!listDiv) return;
                    listDiv.innerHTML = '';
                    if (seriesArray.length === 0) {
                        listDiv.innerHTML = `<p class="text-center" style="color: var(--text-secondary);">No hay series disponibles.</p>`;
                        return;
                    }
                    seriesArray.forEach((serie, index) => {
                        const item = document.createElement('div');
                        item.className = 'series-list-item';
                        item.onclick = () => displaySeriesDetail(index);
                        const img = document.createElement('img');
                        img.src = serie.imagen || placeholderImage;
                        img.alt = `Portada de ${serie.tituloSerie || 'Serie'}`;
                        img.onerror = () => { img.src = placeholderImage; };
                        const textDiv = document.createElement('div');
                        textDiv.className = 'text-content';
                        const title = document.createElement('h3');
                        title.textContent = serie.tituloSerie || 'Serie sin título';
                        const desc = document.createElement('p');
                        const shortDesc = serie.descripcion ? (serie.descripcion.length > 100 ? serie.descripcion.substring(0, 97) + '...' : serie.descripcion) : 'Sin descripción.';
                        desc.textContent = shortDesc;
                        textDiv.appendChild(title);
                        textDiv.appendChild(desc);
                        item.appendChild(img);
                        item.appendChild(textDiv);
                        listDiv.appendChild(item);
                    });
                 }

                 // --- Display Series Detail ---
                 function displaySeriesDetail(seriesIndex) {
                     if (seriesIndex < 0 || seriesIndex >= seriesLogic.allSeriesData.length || !detailTitle || !detailDescription || !episodeListDiv) return;
                     currentSeriesIndex = seriesIndex;
                     const serie = seriesLogic.allSeriesData[seriesIndex];
                     detailTitle.textContent = serie.tituloSerie || 'Serie sin título';
                     detailDescription.textContent = serie.descripcion || '';
                     episodeListDiv.innerHTML = ''; // Clear previous episodes

                     if (!serie.episodios || serie.episodios.length === 0) {
                         episodeListDiv.innerHTML = `<p style="color: var(--text-secondary);">No hay episodios.</p>`;
                         if(iframePlayer) iframePlayer.src = 'about:blank';
                         showMessageInPlayer("No hay episodios disponibles.");
                         updatePlayingEpisodeUI(null);
                     } else {
                         serie.episodios.forEach((episodio, index) => {
                             const epItem = document.createElement('div');
                             epItem.className = 'episode-list-item';
                             epItem.textContent = episodio.tituloEpisodio || `Episodio ${index + 1}`;
                             epItem.dataset.url = episodio.urlDrive;
                             epItem.onclick = () => {
                                 loadVideo(episodio.urlDrive);
                                 updatePlayingEpisodeUI(epItem);
                             };
                             episodeListDiv.appendChild(epItem);
                         });
                         if(iframePlayer) iframePlayer.src = 'about:blank'; // Clear player initially
                         showMessageInPlayer("Selecciona un episodio.");
                         updatePlayingEpisodeUI(null);
                     }
                     showSeriesDetailView();
                 }

                 // --- Load Video into Iframe ---
                 function loadVideo(driveUrl) {
                     if (!iframePlayer) return;
                     if (typeof driveUrl === 'string' && driveUrl.includes('/preview')) {
                         iframePlayer.src = driveUrl;
                         hideMessageInPlayer();
                     } else {
                         console.error("URL de episodio Drive inválida:", driveUrl);
                         showMessageInPlayer("Error: URL inválida.");
                         iframePlayer.src = 'about:blank';
                     }
                 }

                 // --- Show/Hide Message in Iframe Container ---
                 function showMessageInPlayer(text) {
                     if(playerMessage) {
                         playerMessage.textContent = text;
                         playerMessage.style.display = 'block';
                     }
                     if(iframePlayer) iframePlayer.style.display = 'none';
                 }
                 function hideMessageInPlayer() {
                     if(playerMessage) playerMessage.style.display = 'none';
                     if(iframePlayer) iframePlayer.style.display = 'block';
                 }

                 // --- Update Playing Episode UI ---
                 function updatePlayingEpisodeUI(playingElement) {
                     if (!episodeListDiv) return;
                     const allEpisodeItems = episodeListDiv.querySelectorAll('.episode-list-item');
                     allEpisodeItems.forEach(item => item.classList.remove('playing'));
                     if (playingElement) {
                         playingElement.classList.add('playing');
                     }
                 }

                 // --- Public Methods/Properties ---
                 return {
                     fetchSeriesData,
                     allSeriesData // Expose data array (read-only recommended)
                     // Add other methods if needed
                 };
             })(); // End seriesLogic IIFE


            // --- Global Keyboard Controls (From M3U8 Logic - Needs review/adaptation) ---
            // This might need adjustment depending on which section is active
            document.addEventListener('keydown', (event) => {
                if (event.target === m3u8Logic.searchInput || event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.isContentEditable) return;

                let activeSection = document.querySelector('.content-section.active');
                let preventDefault = true;

                if (activeSection && activeSection.id === 'tvSection') {
                    // --- M3U8 Keyboard Controls ---
                    const videoPlayer = m3u8Logic.videoPlayer; // Use scoped player
                    const playlistContainer = m3u8Logic.playlistContainer; // Use scoped container
                    if (!videoPlayer) return; // Exit if player not found

                     // Allow playlist navigation default behavior
                     if (playlistContainer?.contains(document.activeElement) && ['ArrowUp', 'ArrowDown', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(event.key)) preventDefault = false;
                     if (document.activeElement?.classList.contains('star') && ['Enter', ' '].includes(event.key)) preventDefault = false;

                    switch (event.key) {
                        case ' ': case 'k': case 'MediaPlayPause': if (videoPlayer.paused) videoPlayer.play().catch(e => console.error("Error playing:", e)); else videoPlayer.pause(); break;
                        case 'Enter': case 'Ok':
                            if (document.activeElement && document.activeElement.classList.contains('channel-button')) { document.activeElement.click(); }
                            else if (document.activeElement && document.activeElement.tagName === 'BUTTON') { preventDefault = false; } // Allow button activation
                            else { if (videoPlayer.paused) videoPlayer.play().catch(e => console.error("Error playing:", e)); else videoPlayer.pause(); }
                            break;
                        case 'ArrowUp':
                            if (!playlistContainer?.contains(document.activeElement)) { const v = Math.min(1, parseFloat((videoPlayer.volume + 0.1).toFixed(1))); videoPlayer.volume = v; videoPlayer.muted = false; }
                            else { preventDefault = false; } // Allow list navigation
                            break;
                        case 'ArrowDown':
                             if (!playlistContainer?.contains(document.activeElement)) { const v = Math.max(0, parseFloat((videoPlayer.volume - 0.1).toFixed(1))); videoPlayer.volume = v; videoPlayer.muted = false; }
                             else { preventDefault = false; } // Allow list navigation
                            break;
                        case 'ArrowRight': videoPlayer.currentTime += 5; break;
                        case 'ArrowLeft': videoPlayer.currentTime -= 5; break;
                        case 'm': case 'M': case 'MediaMute': videoPlayer.muted = !videoPlayer.muted; break;
                        case 'f': case 'F':
                             const playerContainer = m3u8Logic.playerContainer; // Use scoped container
                             if (playerContainer) {
                                 if (!document.fullscreenElement) { if (playerContainer.requestFullscreen) playerContainer.requestFullscreen().catch(err => console.error("FS error:", err)); else if (playerContainer.webkitRequestFullscreen) playerContainer.webkitRequestFullscreen(); }
                                 else { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); }
                             }
                             break;
                        case 'MediaStop': videoPlayer.pause(); videoPlayer.currentTime = 0; break;
                        case 'Escape': if (document.fullscreenElement) { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); } else preventDefault = false; break;
                        default: preventDefault = false; break;
                    }
                } else if (activeSection && activeSection.id === 'seriesSection') {
                    // --- Series Keyboard Controls (Example - can be expanded) ---
                    // Basic example: Allow space to toggle iframe focus (not playback)
                    // More complex controls would require interacting with the iframe content if possible, or managing playback state externally.
                     switch (event.key) {
                         case 'f': case 'F': // Fullscreen for the iframe container
                             const driveContainer = document.querySelector('#seriesDetailContainer .video-container');
                             if (driveContainer) {
                                 if (!document.fullscreenElement) { if (driveContainer.requestFullscreen) driveContainer.requestFullscreen().catch(err => console.error("FS error:", err)); else if (driveContainer.webkitRequestFullscreen) driveContainer.webkitRequestFullscreen(); }
                                 else { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); }
                             }
                             break;
                         case 'Escape': if (document.fullscreenElement) { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); } else preventDefault = false; break;
                         // Add more controls if needed, e.g., for navigating episode list
                         default: preventDefault = false; break;
                     }
                } else {
                     preventDefault = false; // No active section or unknown section
                }

                if (preventDefault) { event.preventDefault(); }
            });

            // --- Mouse Wheel Volume Control (Only for M3U8 player) ---
            const m3u8PlayerContainer = document.getElementById('player-container');
            if(m3u8PlayerContainer) m3u8PlayerContainer.addEventListener('wheel', (event) => {
                const videoPlayer = m3u8Logic.videoPlayer;
                 if (videoPlayer && (event.target === videoPlayer || m3u8PlayerContainer.contains(event.target))) {
                     event.preventDefault();
                     const volumeStep = 0.05;
                     let newVolume = event.deltaY < 0 ? Math.min(1, parseFloat((videoPlayer.volume + volumeStep).toFixed(2))) : Math.max(0, parseFloat((videoPlayer.volume - volumeStep).toFixed(2)));
                     videoPlayer.volume = newVolume;
                     videoPlayer.muted = false;
                 }
            }, { passive: false });


            // --- Initial Application Setup ---
            showSection('tvSection'); // Show TV section by default
            m3u8Logic.initializeApp(); // Initialize M3U8 player
            // Series data will be fetched when the tab is clicked or can be pre-fetched here:
            // seriesLogic.fetchSeriesData(); // Optional: Pre-fetch series data

        }); // End DOMContentLoaded
    </script>
</body>
</html>

        :root {
            /* Color Palette */
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --surface-hover-color: #2a2a2a;
            --primary-accent: #4A90E2; /* Blue accent */
            --primary-accent-hover: #357ABD;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --text-on-accent: #FFFFFF;
            --border-color: #383838;
            --favorite-color: #FFD700; /* Gold for favorite */
            --error-color: #CF6679; /* Red for offline/error */
            --success-color: #2ECC71; /* Green for online */
            --unknown-color: #616161; /* Grey for unknown status */
             --loading-color: var(--primary-accent); /* Color para indicador de carga */

            /* Sizing & Radius */
            --border-radius: 8px;
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --header-height: 70px;
            --header-height-mobile: 60px;
        }

        /* Global Box Sizing & Overflow Control */
        * {
            box-sizing: border-box;
        }

        html, body {
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* General Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header Styles */
        .header {
            background-color: var(--surface-color);
            padding: 0 var(--spacing-m);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            height: var(--header-height);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .header img {
            height: 45px; /* Logo height */
            object-fit: contain;
            flex-shrink: 0; /* Prevent logo from shrinking */
        }

        /* Current Channel Title in Header */
        #current-channel-title {
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 600;
            margin-left: var(--spacing-l); /* Space between logo and title */
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis for long titles */
            flex-grow: 1; /* Allow title to take available space */
            min-width: 0; /* Important for flex-grow + overflow */
        }


        /* Main Container Layout */
        .container {
            display: flex;
            flex-direction: row; /* Player on left, playlist on right */
            max-width: 1600px; /* Max width for large screens */
            margin: calc(var(--header-height) + var(--spacing-m)) auto var(--spacing-m); /* Top margin for fixed header */
            padding: var(--spacing-m);
            height: calc(100vh - var(--header-height) - (2 * var(--spacing-m))); /* Full height minus header and margins */
            overflow: hidden; /* Prevent container scroll, allow internal scroll */
            gap: var(--spacing-l); /* Gap between player and playlist */
        }

        /* Video Player Container */
        #player-container {
            flex: 3; /* Takes up more space */
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: #000; /* Black background for video area */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
        }

        /* Video Element Styling */
        #my-video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Fit video within container without cropping */
            display: block;
            border-radius: var(--border-radius); /* Match container radius */
        }

        /* Playlist Container */
        #playlist-container {
            flex: 1; /* Takes less space */
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-m);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            min-width: 320px; /* Minimum width for playlist */
            max-height: 100%; /* Ensure it doesn't overflow container */
            position: relative; /* For loading indicator */
        }

         /* Container for Title and Count */
        .playlist-title-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-m);
            padding-bottom: var(--spacing-s);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent shrinking */
        }

        #playlist-container h2 {
            margin: 0;
            font-size: 1.25em;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Channel Count Display */
        #channel-count-container {
            width: auto; /* Fit content */
            height: 28px;
            background-color: var(--primary-accent);
            border-radius: 14px; /* Pill shape */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 var(--spacing-s);
            flex-shrink: 0; /* Prevent shrinking */
            margin: 0; /* Reset margin */
        }

        #channel-count-number {
            color: var(--text-on-accent);
            font-size: 0.8em;
            font-weight: 600;
            line-height: 1; /* Ensure text is centered vertically */
        }

        /* Search Input Styling */
        #search {
            width: 100%;
            padding: var(--spacing-s) var(--spacing-m);
            margin-bottom: var(--spacing-m);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background-color: var(--bg-color); /* Slightly darker than surface for contrast */
            color: var(--text-primary);
            font-size: 0.95em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
             flex-shrink: 0; /* Prevent shrinking */
        }

        #search::placeholder {
            color: var(--text-secondary);
        }

        #search:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3); /* Subtle focus ring */
        }

        /* Playlist (UL) Styling */
        #playlist {
            list-style-type: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allow list to take remaining space */
            overflow-y: auto; /* Enable vertical scrolling */
            /* Custom Scrollbar */
            &::-webkit-scrollbar { width: 8px; }
            &::-webkit-scrollbar-track { background: var(--surface-color); border-radius: 4px; }
            &::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 4px; border: 2px solid var(--surface-color); }
            &::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary); }
        }

        /* Playlist Item (LI) Styling */
        #playlist li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: default; /* Default cursor, button inside handles click */
            padding: var(--spacing-s);
            margin-bottom: var(--spacing-s);
            background-color: transparent; /* Use hover effect */
            border-radius: var(--border-radius);
            transition: background-color 0.15s ease-in-out;
            border: 1px solid transparent; /* Placeholder for active border */
        }
        #playlist li:hover {
            background-color: var(--surface-hover-color);
        }

        /* Active Channel Styling */
        #playlist li.active {
            background-color: rgba(74, 144, 226, 0.15); /* Light blue highlight */
            border: 1px solid var(--primary-accent);
        }
        #playlist li.active .channel-title {
             color: var(--primary-accent); /* Highlight title text */
             font-weight: 600;
        }
        #playlist li.active .channel-desc {
             color: var(--text-secondary); /* Keep description subtle */
        }


        /* Channel Button (inside LI) */
         .channel-button {
             background: none;
             border: none;
             padding: 0;
             margin: 0;
             color: inherit;
             font-family: inherit;
             font-size: inherit;
             text-align: left;
             cursor: pointer;
             display: block; /* Make it take full width */
             flex-grow: 1; /* Take available space */
             margin-right: var(--spacing-s); /* Space before star */
             border-radius: var(--border-radius); /* For focus outline */
             overflow: hidden; /* Clip content */
         }

        /* Channel Info Layout (inside button) */
        .channel-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
            overflow: hidden; /* Prevent content overflow */
        }

        /* Status Dot */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--unknown-color); /* Default: Unknown */
            margin-right: var(--spacing-s); /* Space between dot and logo */
            flex-shrink: 0; /* Prevent shrinking */
            transition: background-color 0.3s ease;
        }
        .status-dot.online {
            background-color: var(--success-color); /* Green */
        }
        .status-dot.offline {
            background-color: var(--error-color); /* Red */
        }


        /* Channel Logo */
        .channel-info img {
            width: 32px;
            height: 32px;
            border-radius: 50%; /* Circular logos */
            flex-shrink: 0;
            object-fit: cover; /* Cover the area */
            border: 1px solid var(--border-color); /* Subtle border */
            background-color: var(--border-color); /* Placeholder bg */
        }

        /* Channel Text Details */
        .channel-details {
            overflow: hidden; /* Prevent text overflow */
            display: flex;
            flex-direction: column;
        }

        .channel-title {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--text-primary);
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
             transition: color 0.15s ease-in-out;
        }

        .channel-desc {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin: 2px 0 0 0; /* Small top margin */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
             transition: color 0.15s ease-in-out;
        }

        /* Focus state for channel button (Accessibility) */
        .channel-button:focus {
            outline: none; /* Remove default outline */
        }
        /* Apply focus style to the parent LI for better visibility */
        #playlist li:has(.channel-button:focus-visible) {
             box-shadow: 0 0 0 2px var(--primary-accent); /* Visible focus ring on the item */
             background-color: var(--surface-hover-color);
        }


        /* Favorite Star Icon */
        .star {
            cursor: pointer;
            color: var(--text-secondary); /* Default grey */
            transition: color 0.2s ease, transform 0.2s ease;
            font-size: 1em;
            flex-shrink: 0;
            padding: var(--spacing-xs); /* Clickable area */
            line-height: 1; /* Align icon */
            margin-right: var(--spacing-xs); /* Space before the edge */
        }

        .star:hover {
            transform: scale(1.15); /* Slight grow effect */
            color: var(--text-primary); /* Lighter grey on hover */
        }

        .star.favorite {
            color: var(--favorite-color); /* Gold when favorited */
        }

        .star.favorite:hover {
            filter: brightness(1.1); /* Slightly brighter gold on hover */
        }

        /* Error Overlay Styles */
        .error-overlay {
            position: fixed; /* Cover the whole screen */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9); /* Dark semi-transparent background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Above everything else */
            color: var(--text-primary);
            text-align: center;
            padding: var(--spacing-l);
            display: none; /* Hidden by default */
        }

        .error-message {
            font-size: 1.2em;
            margin-bottom: var(--spacing-l);
            color: var(--error-color); /* Use error color for message */
        }

        .error-buttons {
            display: flex;
            gap: var(--spacing-m);
        }

        .error-button {
            padding: var(--spacing-s) var(--spacing-l);
            background-color: var(--primary-accent);
            border: none;
            border-radius: var(--border-radius);
            color: var(--text-on-accent);
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.95em;
            font-weight: 600;
        }

        .error-button:hover {
            background-color: var(--primary-accent-hover);
        }
        .error-button:focus-visible {
             outline: 2px solid var(--text-on-accent);
             outline-offset: 2px;
        }

        /* Loading Indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1em;
            color: var(--text-secondary);
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-s);
        }
        .loading-indicator.show {
            display: flex;
        }
        .spinner {
            border: 4px solid var(--surface-hover-color); /* Light grey */
            border-top: 4px solid var(--loading-color); /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Responsive Design for Mobile */
        @media (max-width: 768px) {
             .header {
                 height: var(--header-height-mobile);
                 padding: 0 var(--spacing-m);
             }
             .header img {
                 height: 35px; /* Smaller logo */
             }
             /* Hide title on very small screens if needed */
             /* #current-channel-title { display: none; } */

             .container {
                 margin: var(--header-height-mobile) 0 0 0; /* Adjust top margin for mobile header */
                 min-height: calc(100vh - var(--header-height-mobile)); /* Ensure it takes full height */
                 flex-direction: column; /* Stack player and playlist */
                 height: auto; /* Allow content to determine height */
                 padding: 0; /* Remove padding */
                 overflow: visible; /* Allow vertical scroll */
                 gap: 0; /* No gap when stacked */
             }

             #player-container {
                 flex: none; /* Don't flex */
                 height: 40vh; /* Player takes ~40% of viewport height */
                 width: 100%;
                 margin: 0;
                 border-radius: 0; /* Remove border radius */
                 border-left: none;
                 border-right: none;
                 border-top: none; /* Keep bottom border */
             }
             #my-video {
                 border-radius: 0;
             }

             #playlist-container {
                 flex-grow: 1; /* Take remaining space */
                 width: 100%;
                 border-radius: 0;
                 padding: var(--spacing-m);
                 border: none; /* Remove border */
                 min-height: calc(60vh - var(--header-height-mobile)); /* Ensure playlist fills remaining space */
                 max-height: none; /* Allow scrolling */
                 overflow-y: auto; /* Enable scrolling if needed */
                 min-width: unset; /* Remove min-width */
             }

             .playlist-title-container {
                 padding-bottom: var(--spacing-s);
                 margin-bottom: var(--spacing-m);
             }
             #playlist-container h2 {
                 font-size: 1.1em;
             }
             #channel-count-container {
                 height: 24px;
                 padding: 0 6px;
                 border-radius: 12px;
             }
             #channel-count-number {
                 font-size: 0.75em;
             }

             #search {
                 padding: 10px;
                 font-size: 1em;
             }
             #playlist li {
                 padding: 10px;
                 margin-bottom: 6px;
             }
             .status-dot {
                 width: 7px;
                 height: 7px;
                 margin-right: 6px;
             }
             .channel-info img {
                 width: 30px;
                 height: 30px;
             }
             .channel-title {
                 font-size: 0.9em;
             }
             .channel-desc {
                 font-size: 0.75em;
             }
             .star {
                 font-size: 1em;
                 margin-right: var(--spacing-xs); /* Ensure margin applies on mobile too */
             }
        }
    </style>
</head>
<body>
    <header class="header">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgVIFxWI-sdOR2bVfpbgCotXquColWskv4u4I9HXZhYdsRewDVRNcJ7iLvtKO2xYucvqOv0DKY2MArMnHGF8IvZBI7NYjg0dkjHUN0N8VXwZ73vKjYOajWC6JTze5n1Hcj19V2COVFkN-TtJA7uR_ALIYyIcvUBOwQN1EmURskiBCI_lJK3hFphdSBuCaQ/s320/logo%20(%20JORGEDEZ%20)%20ROJO%20Y%20BLANCO%20PARA%20VIDEO.jpeg" alt="JORGEDEZ Logo">
        <span id="current-channel-title">Cargando canales...</span> </header>

    <div class="container">
        <div id="player-container">
            <video id="my-video" controls playsinline webkit-playsinline crossorigin="anonymous">
                Tu navegador no soporta el elemento de video. </video>
        </div>

        <div id="playlist-container">
             <div class="loading-indicator" id="loading-indicator">
                 <div class="spinner"></div>
                 <span>Cargando canales...</span>
             </div>
            <div class="playlist-title-container">
                <h2>Canales</h2>
                <div id="channel-count-container" aria-live="polite" aria-atomic="true">
                    <span id="channel-count-number">0</span> </div>
            </div>
            <input type="text" id="search" placeholder="Buscar canal..." aria-label="Buscar canal" disabled> <ul id="playlist" aria-label="Lista de canales">
                </ul>
        </div>
    </div>

    <div class="error-overlay" id="error-overlay" role="alertdialog" aria-labelledby="error-message" aria-modal="true">
        <div class="error-message" id="error-message">No se pudo cargar el canal. Intente con otro.</div>
        <div class="error-buttons">
            <button class="error-button" id="try-again-button">Intentar nuevamente</button>
            <button class="error-button" id="try-another-button">Probar otro canal</button>
            <button class="error-button" id="reload-list-button">Recargar Lista M3U</button> </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- !!! IMPORTANTE: URL de tu archivo M3U !!! ---
            const m3uUrl = 'https://raw.githubusercontent.com/sejo48/chanejorgedez/refs/heads/main/listaoficial.m3u'; // <-- URL CORREGIDA

            // --- Global Channel Array ---
            let channels = []; // This will be populated by parsing the M3U

            // --- Channel Status Storage Key ---
            const STATUS_STORAGE_KEY = 'channelStatusesTvPlayer'; // Key for localStorage

            // --- Load Statuses ---
            let channelStatuses = JSON.parse(localStorage.getItem(STATUS_STORAGE_KEY)) || {};

            // --- DOM Elements ---
            const videoPlayer = document.getElementById('my-video');
            const playlist = document.getElementById('playlist');
            const searchInput = document.getElementById('search');
            const playerContainer = document.getElementById('player-container');
            const playlistContainer = document.getElementById('playlist-container');
            const errorOverlay = document.getElementById('error-overlay');
            const errorMessage = document.getElementById('error-message');
            const tryAgainButton = document.getElementById('try-again-button');
            const tryAnotherButton = document.getElementById('try-another-button');
            const reloadListButton = document.getElementById('reload-list-button'); // Reload M3U button
            const currentChannelTitleElement = document.getElementById('current-channel-title');
            const countContainer = document.getElementById('channel-count-container');
            const countSpan = document.getElementById('channel-count-number');
            const loadingIndicator = document.getElementById('loading-indicator');

            // --- State Variables ---
            let favorites = JSON.parse(localStorage.getItem('favoritesTvChannels')) || [];
            let lastAttemptedChannel = null;
            let hls = null;
            let currentChannelIndex = null;
            let videoPlayingListener = null;

            // --- Show/Hide Loading Indicator ---
            function showLoading(message = "Cargando canales...") {
                if (loadingIndicator) {
                    loadingIndicator.querySelector('span').textContent = message;
                    loadingIndicator.classList.add('show');
                }
                searchInput.disabled = true; // Disable search while loading
                playlist.innerHTML = ''; // Clear playlist while loading
                 if (countSpan) countSpan.textContent = '...'; // Show loading in count
            }

            function hideLoading() {
                if (loadingIndicator) {
                    loadingIndicator.classList.remove('show');
                }
                searchInput.disabled = false; // Enable search after loading
            }

            // --- M3U Parsing Function (CORREGIDA PARA TÍTULOS) ---
            async function fetchAndParseM3U(url) {
                showLoading();
                console.log(`Fetching M3U from: ${url}`);
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const m3uText = await response.text();
                    console.log("M3U content fetched successfully.");

                    const lines = m3uText.split(/[\r\n]+/); // Usar regex para saltos de línea
                    const parsedChannels = [];
                    let currentChannelInfo = null; // Almacena info de #EXTINF temporalmente

                    // Regex mejoradas para atributos y título
                    const extinfRegex = /#EXTINF:(-?\d+)(.*)/; // Captura duración y el resto de la línea
                    const attributeRegex = /(\S+?)=(?:"([^"]*)"|([^ ]*))/g; // Captura clave="valor" o clave=valor_sin_espacios
                    const titleCommaRegex = /,(?!")(.*)/; // Captura texto después de la última coma (que no esté dentro de comillas)


                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (!trimmedLine) continue; // Ignorar líneas vacías

                        if (trimmedLine.startsWith('#EXTINF:')) {
                            const match = trimmedLine.match(extinfRegex);
                            if (match) {
                                currentChannelInfo = { // Usar objeto temporal
                                    duration: match[1],
                                    attributes: {},
                                    title: '', // Inicializar vacío
                                    logo: '', // Inicializar vacío
                                    url: ''
                                };
                                const restOfLine = match[2] || '';

                                // 1. Extraer atributos
                                let attrMatch;
                                while ((attrMatch = attributeRegex.exec(restOfLine)) !== null) {
                                    const key = attrMatch[1].toLowerCase();
                                    const value = attrMatch[2] !== undefined ? attrMatch[2] : attrMatch[3];
                                    currentChannelInfo.attributes[key] = value;
                                }

                                // 2. **PRIORIDAD:** Obtener título de tvg-name
                                if (currentChannelInfo.attributes['tvg-name']) {
                                    currentChannelInfo.title = currentChannelInfo.attributes['tvg-name'].trim();
                                }

                                // 3. **FALLBACK:** Si no hay tvg-name, obtener título después de la coma
                                if (!currentChannelInfo.title) {
                                    const titleMatch = restOfLine.match(titleCommaRegex);
                                    if (titleMatch && titleMatch[1]) {
                                        currentChannelInfo.title = titleMatch[1].trim();
                                    }
                                }

                                // 4. Si AÚN no hay título, marcarlo
                                if (!currentChannelInfo.title) {
                                     currentChannelInfo.title = 'Sin Título';
                                }

                                // 5. Obtener logo de tvg-logo
                                currentChannelInfo.logo = currentChannelInfo.attributes['tvg-logo'] || '';

                                // 6. Crear descripción simple
                                currentChannelInfo.descripcion = `Canal: ${currentChannelInfo.title}`;

                            } else {
                                // Línea #EXTINF mal formada
                                console.warn("Línea #EXTINF no reconocida:", trimmedLine);
                                currentChannelInfo = null; // Invalidar
                            }
                        } else if (currentChannelInfo && trimmedLine && !trimmedLine.startsWith('#')) {
                            // Esta línea debería ser la URL
                            currentChannelInfo.url = trimmedLine;
                            if (currentChannelInfo.url) {
                                parsedChannels.push(currentChannelInfo); // Añadir canal completo
                            } else {
                                console.warn("Skipping channel entry with missing URL:", currentChannelInfo.title);
                            }
                            currentChannelInfo = null; // Resetear para el próximo canal
                        }
                        // Ignorar otras líneas # (comentarios, #EXTM3U, etc.) aquí, se manejan al generar
                    }


                    console.log(`Parsed ${parsedChannels.length} channels.`);
                    if (parsedChannels.length === 0 && lines.length > 1) { // Evitar error si el archivo está vacío o solo tiene #EXTM3U
                         showM3UError("No se encontraron canales válidos en el archivo M3U.");
                         return []; // Return empty array on parsing failure
                    }
                    return parsedChannels;

                } catch (error) {
                    console.error('Error fetching or parsing M3U:', error);
                    showM3UError(`Error al cargar la lista M3U: ${error.message}. Verifica la URL e inténtalo de nuevo.`);
                    return []; // Return empty array on error
                } finally {
                    hideLoading();
                }
            }

            // --- Show M3U Loading Error ---
            function showM3UError(message) {
                 errorMessage.textContent = message;
                 errorOverlay.style.display = 'flex';
                 tryAgainButton.style.display = 'none';
                 tryAnotherButton.style.display = 'none';
                 reloadListButton.style.display = 'inline-block';
            }


            // --- Helper: Update Status (Visual + Storage) ---
            function updateChannelStatus(index, status) {
                if (index === null || index < 0 || index >= channels.length) return;
                console.log(`Updating status for index ${index} to ${status}`);
                channelStatuses[index] = status;
                localStorage.setItem(STATUS_STORAGE_KEY, JSON.stringify(channelStatuses));

                const listItem = playlist.querySelector(`li[data-original-index="${index}"]`);
                if (listItem) {
                    const dot = listItem.querySelector('.status-dot');
                    if (dot) {
                        dot.classList.remove('online', 'offline');
                        let statusTitle = 'Desconocido';
                        if (status === 'online') {
                            dot.classList.add('online');
                            statusTitle = 'En línea (última vez probado)';
                        } else if (status === 'offline') {
                            dot.classList.add('offline');
                            statusTitle = 'Fuera de línea (última vez probado)';
                        }
                        dot.title = `Estado: ${statusTitle}`;
                    }
                }
            }


            // --- Error Handling (for channel playback) ---
            function showError(message, channelIndex) {
                console.error("Playback Error Triggered:", message, "Channel Index:", channelIndex);
                lastAttemptedChannel = channelIndex;
                errorMessage.textContent = message;
                errorOverlay.style.display = 'flex';
                 tryAgainButton.style.display = 'inline-block';
                 tryAnotherButton.style.display = 'inline-block';
                 reloadListButton.style.display = 'none';

                if (hls) { hls.stopLoad(); hls.destroy(); hls = null; }
                videoPlayer.pause();
                videoPlayer.removeAttribute('src');
                videoPlayer.load();

                if (currentChannelTitleElement) {
                    currentChannelTitleElement.textContent = 'Error al cargar canal';
                }
                if (channelIndex !== null && channelIndex < channels.length) { // Check bounds
                    updateChannelStatus(channelIndex, 'offline');
                }
            }

            function hideError() {
                errorOverlay.style.display = 'none';
            }

            // --- Event Listeners for Error Buttons ---
            tryAgainButton.addEventListener('click', () => {
                hideError();
                if (lastAttemptedChannel !== null && lastAttemptedChannel >= 0 && lastAttemptedChannel < channels.length) {
                    selectChannel(lastAttemptedChannel);
                }
            });

            tryAnotherButton.addEventListener('click', () => {
                hideError();
            });

             // Reload M3U List Button
             reloadListButton.addEventListener('click', () => {
                 hideError();
                 initializeApp(); // Re-run the initialization process
             });

            // --- Playlist Rendering ---
            function renderPlaylist(channelsToRender = channels) {
                playlist.innerHTML = ''; // Clear existing playlist

                if (!channelsToRender || channelsToRender.length === 0) {
                     if (countSpan) countSpan.textContent = '0';
                     if (currentChannelTitleElement) currentChannelTitleElement.textContent = 'No hay canales';
                     const noChannelsMsg = document.createElement('li');
                     noChannelsMsg.textContent = 'No hay canales para mostrar.';
                     noChannelsMsg.style.color = 'var(--text-secondary)';
                     noChannelsMsg.style.textAlign = 'center';
                     noChannelsMsg.style.marginTop = 'var(--spacing-l)';
                     playlist.appendChild(noChannelsMsg);
                    return;
                }

                 if (countSpan) countSpan.textContent = channelsToRender.length;


                const sortedChannels = [...channelsToRender].sort((a, b) => {
                    const aIndex = channels.findIndex(ch => ch.url === a.url);
                    const bIndex = channels.findIndex(ch => ch.url === b.url);
                    const aIsFavorite = favorites.includes(aIndex.toString());
                    const bIsFavorite = favorites.includes(bIndex.toString());

                    if (aIsFavorite && !bIsFavorite) return -1;
                    if (!aIsFavorite && bIsFavorite) return 1;
                    if (a.title && b.title) {
                         return a.title.localeCompare(b.title);
                    }
                    return 0;
                });

                sortedChannels.forEach((channel) => {
                    const originalIndex = channels.findIndex(ch => ch.url === channel.url);
                    if (originalIndex === -1) return;

                    const li = document.createElement('li');
                    li.dataset.originalIndex = originalIndex;

                    const channelButton = document.createElement('button');
                    channelButton.classList.add('channel-button');
                    channelButton.type = 'button';
                    channelButton.setAttribute('aria-label', `Reproducir ${channel.title || 'Canal sin título'}`);

                    const currentStatus = channelStatuses[originalIndex];
                    const statusTitle = currentStatus === 'online' ? 'En línea (última vez probado)' :
                                        currentStatus === 'offline' ? 'Fuera de línea (última vez probado)' :
                                        'Desconocido';

                    const logoSrc = channel.logo || `https://placehold.co/32x32/383838/A0A0A0?text=${encodeURIComponent((channel.title || '?').charAt(0))}`;
                    const logoAlt = channel.logo ? '' : `${channel.title || 'Canal'} Logo Placeholder`;

                    channelButton.innerHTML = `
                        <div class="channel-info">
                            <span class="status-dot ${currentStatus || ''}" title="Estado: ${statusTitle}"></span>
                            <img src="${logoSrc}" alt="${logoAlt}" onerror="this.onerror=null; this.src='https://placehold.co/32x32/383838/A0A0A0?text=${encodeURIComponent((channel.title || '?').charAt(0))}'; this.alt='${channel.title || 'Canal'} Logo Placeholder';" loading="lazy">
                            <div class="channel-details">
                                <span class="channel-title">${channel.title || 'Canal sin título'}</span>
                                <p class="channel-desc">${channel.descripcion || 'Sin descripción'}</p>
                            </div>
                        </div>
                    `;

                    channelButton.addEventListener('click', () => {
                        selectChannel(originalIndex);
                    });

                    li.appendChild(channelButton);

                    const star = document.createElement('i');
                    const isFavorite = favorites.includes(originalIndex.toString());
                    star.className = `star fas fa-star ${isFavorite ? 'favorite' : ''}`;
                    star.dataset.index = originalIndex;
                    star.setAttribute('role', 'button');
                    star.setAttribute('aria-pressed', isFavorite.toString());
                    star.setAttribute('aria-label', isFavorite ? `Quitar ${channel.title || 'Canal'} de favoritos` : `Añadir ${channel.title || 'Canal'} a favoritos`);
                    star.tabIndex = 0;

                    star.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleFavorite(originalIndex.toString());
                        const currentSearchTerm = searchInput.value.toLowerCase();
                        renderPlaylist(currentSearchTerm ? filterChannels(currentSearchTerm) : channels);
                        if (currentChannelIndex !== null) {
                             setActiveChannelHighlight(currentChannelIndex);
                        }
                    });
                    star.addEventListener('keydown', (e) => {
                         if (e.key === 'Enter' || e.key === ' ') {
                             e.preventDefault();
                             e.stopPropagation();
                             toggleFavorite(originalIndex.toString());
                             const currentSearchTerm = searchInput.value.toLowerCase();
                             renderPlaylist(currentSearchTerm ? filterChannels(currentSearchTerm) : channels);
                             if (currentChannelIndex !== null) {
                                 setActiveChannelHighlight(currentChannelIndex);
                             }
                         }
                    });

                    li.appendChild(star);
                    playlist.appendChild(li);
                });

                if (currentChannelIndex !== null && currentChannelIndex < channels.length) {
                    setActiveChannelHighlight(currentChannelIndex);
                }
            }

            // --- Filter Channels ---
             function filterChannels(searchTerm) {
                 if (!channels || channels.length === 0) return [];
                 return channels.filter(ch =>
                     (ch.title && ch.title.toLowerCase().includes(searchTerm)) ||
                     (ch.descripcion && ch.descripcion.toLowerCase().includes(searchTerm))
                 );
             }

            // --- Set Active Channel Highlight ---
            function setActiveChannelHighlight(index) {
                if (index === null || index < 0 || index >= channels.length) return;
                document.querySelectorAll('#playlist li').forEach(item => {
                    item.classList.remove('active');
                });
                const activeListItem = playlist.querySelector(`li[data-original-index="${index}"]`);
                if (activeListItem) {
                    activeListItem.classList.add('active');
                }
            }

            // --- Select Channel ---
            function selectChannel(index) {
                if (index === null || index === undefined || index < 0 || index >= channels.length) {
                    showError("Error interno: Índice de canal inválido.", index);
                    return;
                }
                hideError();
                const channel = channels[index];
                console.log(`Selecting channel ${index}: ${channel.title || 'Canal sin título'}`);

                if (currentChannelTitleElement) {
                    currentChannelTitleElement.textContent = channel.title || 'Canal sin título';
                    currentChannelTitleElement.title = channel.title || 'Canal sin título';
                }

                playVideo(channel.url, index);

                scrollToPlayer();
                localStorage.setItem('lastPlayedTvChannel', index.toString());
                currentChannelIndex = index;
                setActiveChannelHighlight(index);
            }

            // --- Play Video (HLS Handling) ---
             function playVideo(url, channelIndex) {
                console.log(`Attempting to play URL: ${url} for channel index: ${channelIndex}`);
                lastAttemptedChannel = channelIndex;

                if (!url || typeof url !== 'string' || url.trim() === '') {
                     console.error("Invalid or missing URL for channel index:", channelIndex);
                     showError("URL del canal inválida o faltante en la lista M3U.", channelIndex);
                     return;
                }

                if (hls) { hls.destroy(); hls = null; }
                videoPlayer.removeAttribute('src');
                videoPlayer.load();
                videoPlayer.removeEventListener('error', handleVideoElementError);
                 if (videoPlayingListener) { videoPlayer.removeEventListener('playing', videoPlayingListener); videoPlayingListener = null; }

                const isM3U8 = url.includes('.m3u8') || url.includes('mpegurl');

                 const handlePlaying = () => {
                     if (lastAttemptedChannel === channelIndex) {
                         console.log(`Video playing event received for index ${channelIndex}.`);
                         updateChannelStatus(channelIndex, 'online');
                     }
                 };
                 videoPlayingListener = handlePlaying;

                if (Hls.isSupported() && isM3U8) {
                    console.log("Using HLS.js for playback.");
                    hls = new Hls({});
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS.js Error:', event, data);
                        if (data.fatal) {
                            let errorMsg = `Error desconocido (${data.details}). Intente otro canal.`;
                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR: errorMsg = `Error de red (${data.details}). Verifique conexión e intente de nuevo.`; break;
                                case Hls.ErrorTypes.MEDIA_ERROR: errorMsg = `Error en los datos del video (${data.details}). Intente otro canal.`; break;
                            }
                            showError(errorMsg, channelIndex);
                            if (data.type === Hls.ErrorTypes.MEDIA_ERROR || data.type === Hls.ErrorTypes.OTHER_ERROR) { if (hls) hls.destroy(); hls = null; }
                        } else { console.warn('Non-fatal HLS Error:', data.details); }
                    });
                    hls.loadSource(url);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log("HLS Manifest parsed. Attempting playback...");
                        videoPlayer.play().catch(e => { console.error("Error starting playback after manifest parsed:", e); });
                    });
                    videoPlayer.addEventListener('playing', videoPlayingListener, { once: true });

                } else if (isM3U8 && videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    console.log("Using native HLS support.");
                    videoPlayer.src = url;
                    videoPlayer.addEventListener('error', handleVideoElementError);
                    videoPlayer.addEventListener('loadedmetadata', () => {
                         console.log("Native HLS metadata loaded. Attempting playback...");
                         videoPlayer.play().catch(e => { console.error("Error starting native playback:", e); });
                    }, { once: true });
                    videoPlayer.addEventListener('playing', videoPlayingListener, { once: true });

                } else {
                    console.warn("URL is not a valid M3U8 or HLS is not supported/needed. URL:", url);
                     if (!isM3U8) {
                         console.log("Attempting direct playback for non-M3U8 URL.");
                         videoPlayer.src = url;
                         videoPlayer.addEventListener('error', handleVideoElementError);
                         videoPlayer.addEventListener('loadeddata', () => {
                             console.log("Direct video data loaded. Attempting playback...");
                             videoPlayer.play().catch(e => { console.error("Error starting direct playback:", e); });
                         }, { once: true });
                         videoPlayer.addEventListener('playing', videoPlayingListener, { once: true });
                     } else {
                         showError("Formato M3U8 no soportado por este navegador sin HLS.js.", channelIndex);
                     }
                }
            }

            // --- Native Video Element Error Handler ---
             function handleVideoElementError() {
                 const error = videoPlayer.error;
                  if (!error || lastAttemptedChannel === null || lastAttemptedChannel >= channels.length) return;

                 console.error("Native <video> Element Error:", error);
                 let message = "Error desconocido al cargar el video.";
                 if (error) {
                      switch (error.code) {
                          case error.MEDIA_ERR_ABORTED: message = 'Carga de video abortada.'; break;
                          case error.MEDIA_ERR_NETWORK: message = 'Error de red al cargar video.'; break;
                          case error.MEDIA_ERR_DECODE: message = 'Error de decodificación de video.'; break;
                          case error.MEDIA_ERR_SRC_NOT_SUPPORTED: message = 'Formato no soportado o URL inválida.'; break;
                          default: message = `Error desconocido (código ${error.code}).`; break;
                      }
                 }
                 showError(message, lastAttemptedChannel);
                 videoPlayer.removeEventListener('error', handleVideoElementError);
             }

            // --- Scroll To Player ---
            function scrollToPlayer() {
                if (window.innerWidth <= 768) {
                    playerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            // --- Toggle Favorite ---
            function toggleFavorite(indexString) {
                 const index = parseInt(indexString);
                 if (isNaN(index)) return;

                 const indexInFavorites = favorites.indexOf(indexString);
                 if (indexInFavorites > -1) {
                     favorites.splice(indexInFavorites, 1);
                 } else {
                     favorites.push(indexString);
                 }
                 localStorage.setItem('favoritesTvChannels', JSON.stringify(favorites));
            }

            // --- Keyboard Controls ---
            document.addEventListener('keydown', (event) => {
                if (event.target === searchInput || event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.isContentEditable) return;
                let preventDefault = true;
                 if (playlistContainer.contains(document.activeElement) && ['ArrowUp', 'ArrowDown', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(event.key)) preventDefault = false;
                 if (document.activeElement?.classList.contains('star') && ['Enter', ' '].includes(event.key)) preventDefault = false;

                switch (event.key) {
                    case ' ': case 'k': case 'MediaPlayPause': if (videoPlayer.paused) videoPlayer.play().catch(e => console.error("Error playing:", e)); else videoPlayer.pause(); break;
                    case 'Enter': case 'Ok': if (document.activeElement && document.activeElement.classList.contains('channel-button')) { document.activeElement.click(); } else if (document.activeElement && document.activeElement.tagName === 'BUTTON') { preventDefault = false; } else { if (videoPlayer.paused) videoPlayer.play().catch(e => console.error("Error playing:", e)); else videoPlayer.pause(); } break;
                    case 'ArrowUp': if (!playlistContainer.contains(document.activeElement)) { const v = Math.min(1, parseFloat((videoPlayer.volume + 0.1).toFixed(1))); videoPlayer.volume = v; videoPlayer.muted = false; } else { preventDefault = false; } break;
                    case 'ArrowDown': if (!playlistContainer.contains(document.activeElement)) { const v = Math.max(0, parseFloat((videoPlayer.volume - 0.1).toFixed(1))); videoPlayer.volume = v; videoPlayer.muted = false; } else { preventDefault = false; } break;
                    case 'ArrowRight': if (!playlistContainer.contains(document.activeElement)) videoPlayer.currentTime += 5; break; // Allow seeking even if playlist focused
                    case 'ArrowLeft': if (!playlistContainer.contains(document.activeElement)) videoPlayer.currentTime -= 5; break; // Allow seeking even if playlist focused
                    case 'm': case 'M': case 'MediaMute': videoPlayer.muted = !videoPlayer.muted; break;
                    case 'f': case 'F': if (!document.fullscreenElement) { if (playerContainer.requestFullscreen) playerContainer.requestFullscreen().catch(err => console.error("FS error:", err)); else if (playerContainer.webkitRequestFullscreen) playerContainer.webkitRequestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); } break;
                    case 'MediaStop': videoPlayer.pause(); videoPlayer.currentTime = 0; break;
                    case 'Escape': if (document.fullscreenElement) { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); } else preventDefault = false; break;
                    default: preventDefault = false; break;
                }
                if (preventDefault) { event.preventDefault(); }
            });

            // --- Mouse Wheel Volume Control ---
            playerContainer.addEventListener('wheel', (event) => {
                 if (event.target === videoPlayer || playerContainer.contains(event.target) && !playlistContainer.contains(event.target)) {
                    event.preventDefault();
                    const volumeStep = 0.05;
                    let newVolume = event.deltaY < 0 ? Math.min(1, parseFloat((videoPlayer.volume + volumeStep).toFixed(2))) : Math.max(0, parseFloat((videoPlayer.volume - volumeStep).toFixed(2)));
                    videoPlayer.volume = newVolume;
                    videoPlayer.muted = false;
                 }
            }, { passive: false });

            // --- Search Functionality ---
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase().trim();
                renderPlaylist(filterChannels(searchTerm));
            });

            // --- Initialization Function ---
            async function initializeApp() {
                channels = await fetchAndParseM3U(m3uUrl);
                renderPlaylist();

                if (channels.length > 0) {
                    const lastPlayedIndexStr = localStorage.getItem('lastPlayedTvChannel');
                    let initialChannelIndex = 0;
                    if (lastPlayedIndexStr !== null) {
                        const lastPlayedIndex = parseInt(lastPlayedIndexStr);
                        if (!isNaN(lastPlayedIndex) && lastPlayedIndex >= 0 && lastPlayedIndex < channels.length) {
                            initialChannelIndex = lastPlayedIndex;
                        } else {
                            localStorage.removeItem('lastPlayedTvChannel');
                        }
                    }
                    currentChannelIndex = initialChannelIndex;
                    if (currentChannelTitleElement) {
                        currentChannelTitleElement.textContent = channels[initialChannelIndex].title || 'Canal sin título';
                        currentChannelTitleElement.title = channels[initialChannelIndex].title || 'Canal sin título';
                    }
                    setActiveChannelHighlight(initialChannelIndex);
                } else {
                     if (currentChannelTitleElement) currentChannelTitleElement.textContent = 'Error al cargar lista';
                }
            }

            // --- Start the application ---
            initializeApp();

        }); // End DOMContentLoaded
    </script>
</body>
</html>
