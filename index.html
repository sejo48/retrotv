<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Playlist de Series</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Applying styles inspired by the first version */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-100 */
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; } /* bg-gray-800 */
        ::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 10px; border: 2px solid #1f2937; } /* bg-gray-600, border-gray-800 */
        ::-webkit-scrollbar-thumb:hover { background-color: #6b7280; } /* bg-gray-500 */

        /* Modal backdrop */
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: flex; } /* Use flex for centering */

        /* Input styling (merged from both versions) */
        .form-input, .form-textarea, .search-input {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            color: #f3f4f6; /* text-gray-100 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-textarea:focus, .search-input:focus {
            outline: none;
            border-color: #3b82f6; /* border-blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .form-textarea { min-height: 80px; resize: vertical; }

        /* Button styles (merged and refined) */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: 1px solid transparent;
        }
        .btn:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); }
        .btn:active:not(:disabled) { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }

        .btn-secondary { background-color: #374151; color: #f3f4f6; } /* Adjusted secondary */
        .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }

        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }

        .btn-success { background-color: #16a34a; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #15803d; }

        .btn-icon {
            padding: 0.4rem; /* Slightly larger padding */
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            font-size: 0.9rem; /* Adjusted icon size */
            line-height: 1;
        }
        /* Style for file input label button */
         .btn-file-input-label {
             background-color: #374151; color: #f3f4f6;
             padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid #4b5563; /* Added border */
         }
         .btn-file-input-label:hover { background-color: #4b5563; }


        /* Series list item (from first version) */
        .series-list-item {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            margin-bottom: 0.5rem; /* Added margin */
            word-break: break-word;
        }
        .series-list-item:hover {
            background-color: #374151; /* bg-gray-700 */
            border-color: #4b5563; /* border-gray-600 */
        }
        .series-list-item.selected {
            background-color: #1d4ed8; /* bg-blue-700 */
            border-color: #1e40af; /* border-blue-800 */
            color: white;
            font-weight: 500; /* Removed bold */
        }
        .series-list-item .delete-series-btn { /* Target specific delete button */
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .series-list-item:hover .delete-series-btn,
        .series-list-item:focus-within .delete-series-btn { /* Show on focus too */
            opacity: 1;
        }

        /* Season tabs (from first version) */
        .season-tab {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            color: #d1d5db; /* text-gray-300 */
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500; /* Added */
        }
        .season-tab:hover { background-color: #374151; }
        .season-tab.active {
            background-color: #1d4ed8; /* bg-blue-700 */
            color: white;
            border-color: #1e40af; /* border-blue-800 */
            font-weight: 600; /* Bolder when active */
        }

        /* Episode list entry (from first version) */
        .episode-list-entry {
            padding: 0.75rem 1rem; /* Increased padding */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            margin-bottom: 0.5rem; /* Added margin */
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        .episode-list-entry:hover {
            background-color: #374151; /* bg-gray-700 */
            border-color: #4b5563; /* border-gray-600 */
        }
        .episode-actions { /* Container for episode buttons */
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex; /* Ensure buttons are inline */
            gap: 0.25rem; /* gap-1 */
        }
        .episode-list-entry:hover .episode-actions,
        .episode-list-entry:focus-within .episode-actions { /* Show on focus too */
            opacity: 1;
        }

        /* Placeholder (from first version) */
        .detail-panel-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            min-height: 300px; /* Ensure minimum height */
            color: #9ca3af; /* text-gray-400 */
            border: 2px dashed #374151; /* border-gray-700 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 2rem;
            text-align: center;
        }

        /* Custom glow effect (from first version) */
        .glow-effect {
            transition: box-shadow 0.3s ease;
        }
        .glow-effect:hover:not(:disabled) {
            box-shadow: 0 0 8px 1px rgba(59, 130, 246, 0.4); /* Subtle blue glow */
        }

    </style>
</head>
<body class="min-h-screen p-4 md:p-6 bg-gray-900"> <div class="max-w-7xl mx-auto bg-gray-850 rounded-xl shadow-2xl overflow-hidden border border-gray-700"> <div class="bg-gradient-to-r from-blue-900 to-indigo-900 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">
                        <i class="fas fa-tv mr-3"></i> Editor de Playlist de Series
                    </h1>
                    <p class="text-blue-200 mt-1">Organiza tus series favoritas en una playlist personalizada</p>
                </div>
                <div class="hidden md:block">
                    <div class="bg-blue-800 bg-opacity-50 rounded-full p-3">
                        <i class="fas fa-film text-blue-300 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-6 border-b border-gray-700 bg-gray-750"> <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-200 mb-3 flex items-center">
                        <i class="fas fa-file-import mr-2 text-blue-400"></i> Cargar Playlist
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="loadJsonFile" class="btn btn-file-input-label w-full glow-effect"> <i class="fas fa-upload mr-2"></i> Seleccionar archivo JSON
                            </label>
                            <input type="file" id="loadJsonFile" class="hidden" accept=".json">
                            <p class="text-xs text-gray-400 mt-2 text-center">Selecciona tu archivo playlist.json local</p>
                        </div>
                        <div class="relative">
                            <textarea id="pasteJsonArea" rows="4" class="form-textarea text-sm"
                                      placeholder="O pega aquí el contenido JSON de tu playlist..."></textarea>
                            <button id="loadFromJsonTextBtn" class="btn btn-primary w-full mt-2 glow-effect"> <i class="fas fa-paste mr-2"></i> Cargar desde texto
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 flex flex-col">
                    <h3 class="text-lg font-semibold text-gray-200 mb-3 flex items-center">
                        <i class="fas fa-file-export mr-2 text-green-400"></i> Exportar Playlist
                    </h3>
                    <div class="flex-grow flex flex-col justify-center">
                        <button id="generateJsonBtn" class="btn btn-success glow-effect"> <i class="fas fa-download mr-2"></i> Descargar playlist.json
                        </button>
                        <p class="text-xs text-gray-400 mt-3 text-center">
                            Guarda tu playlist para usarla más tarde o compartirla
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-0 min-h-[60vh]">

            <div class="md:col-span-1 p-4 border-r border-gray-700 bg-gray-800 flex flex-col"> <div class="flex justify-between items-center mb-4"> <h3 class="text-lg font-semibold text-gray-200 flex items-center">
                         <i class="fas fa-list mr-2 text-blue-400"></i> Tus Series
                     </h3>
                     <button id="addSeriesBtn" class="btn btn-primary btn-icon glow-effect" title="Añadir nueva serie"> <i class="fas fa-plus"></i>
                     </button>
                 </div>
                 <div class="mb-3 relative"> <input type="search" id="seriesSearchInput" class="search-input pl-10 text-sm" placeholder="Buscar serie..."> <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i> </div>
                 <div id="seriesList" class="space-y-2 flex-grow overflow-y-auto pr-1"> <p class="text-gray-400 text-center p-4 text-sm">No hay series cargadas.</p> </div>
            </div>

            <div id="detailPanel" class="md:col-span-3 p-6 bg-gray-850 flex flex-col"> <div id="detailPanelPlaceholder" class="detail-panel-placeholder flex-grow">
                     <i class="fas fa-arrow-left text-4xl mb-4 text-gray-600"></i>
                     <h3 class="text-xl font-semibold text-gray-300 mb-2">Selecciona una serie</h3>
                     <p class="text-gray-500 max-w-md">
                         Elige una serie de la lista para ver y editar sus detalles, temporadas y episodios.
                     </p>
                 </div>
                 <div id="detailPanelContent" class="hidden flex flex-col h-full">
                     </div>
            </div>

        </div>
    </div>

    <div id="seriesModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md animate-fade-in border border-gray-700"> <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 id="seriesModalTitle" class="text-xl font-semibold text-gray-200 flex items-center">
                    <i class="fas fa-tv mr-2 text-blue-400"></i>
                    <span>Añadir Nueva Serie</span>
                </h3>
                <button id="closeSeriesModalBtn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <form id="seriesForm" class="p-6">
                <input type="hidden" id="editSeriesIndex">
                <div class="mb-4">
                    <label for="tituloSerie" class="block text-sm font-medium text-gray-300 mb-2">
                         <i class="fas fa-heading mr-1 text-blue-400"></i> Título de la Serie
                    </label>
                    <input type="text" id="tituloSerie" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="descripcionSerie" class="block text-sm font-medium text-gray-300 mb-2">
                         <i class="fas fa-align-left mr-1 text-blue-400"></i> Descripción
                    </label>
                    <textarea id="descripcionSerie" class="form-textarea"></textarea>
                </div>
                <div class="mb-4">
                    <label for="imagenSerie" class="block text-sm font-medium text-gray-300 mb-2">
                         <i class="fas fa-image mr-1 text-blue-400"></i> URL de la Imagen
                    </label>
                    <input type="url" id="imagenSerie" class="form-input" placeholder="https://...">
                </div>
                <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-700">
                    <button type="button" id="cancelSeriesBtn" class="btn btn-secondary glow-effect">Cancelar</button> <button type="submit" class="btn btn-primary glow-effect"> <i class="fas fa-save mr-1"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="episodeModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-md animate-fade-in border border-gray-700"> <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                 <h3 id="episodeModalTitle" class="text-xl font-semibold text-gray-200 flex items-center">
                     <i class="fas fa-film mr-2 text-blue-400"></i>
                     <span>Añadir Episodio</span>
                 </h3>
                  <button id="closeEpisodeModalBtn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
             </div>
             <form id="episodeForm" class="p-6">
                 <input type="hidden" id="editEpisodeSeriesIndex">
                 <input type="hidden" id="editEpisodeSeasonIndex">
                 <input type="hidden" id="editEpisodeIndex">
                 <div class="mb-4">
                     <label for="tituloEpisodio" class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-heading mr-1 text-blue-400"></i> Título del Episodio
                     </label>
                     <input type="text" id="tituloEpisodio" class="form-input" required>
                 </div>
                 <div class="mb-4">
                     <label for="urlDriveEpisodio" class="block text-sm font-medium text-gray-300 mb-2">
                          <i class="fas fa-link mr-1 text-blue-400"></i> URL del Video
                     </label>
                     <input type="url" id="urlDriveEpisodio" class="form-input" placeholder="https://..." required>
                     <p class="text-xs text-gray-400 mt-2">Soporta enlaces de Drive, ok.ru y otros servicios</p>
                 </div>
                 <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-700">
                     <button type="button" id="cancelEpisodeBtn" class="btn btn-secondary glow-effect">Cancelar</button> <button type="submit" class="btn btn-primary glow-effect"> <i class="fas fa-save mr-1"></i> Guardar
                     </button>
                 </div>
             </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("LOG: DOM loaded - Estilo Mejorado");

            // --- State ---
            let seriesData = [];
            let selectedSeriesIndex = null; // Index in the original seriesData array
            let selectedSeasonIndex = null; // Index within the selected series' temporadas array
            let editingSeriesIndex = null; // Track which series index is being edited in the modal
            let editingEpisodeInfo = null; // { seriesIndex, seasonIndex, episodeIndex } for episode modal

            // --- DOM Elements ---
            const seriesListDiv = document.getElementById('seriesList');
            const addSeriesBtn = document.getElementById('addSeriesBtn');
            const generateJsonBtn = document.getElementById('generateJsonBtn');
            const loadJsonFileInput = document.getElementById('loadJsonFile');
            const pasteJsonArea = document.getElementById('pasteJsonArea');
            const loadFromJsonTextBtn = document.getElementById('loadFromJsonTextBtn');
            const seriesSearchInput = document.getElementById('seriesSearchInput');
            // Detail Panel Elements
            const detailPanel = document.getElementById('detailPanel');
            const detailPanelPlaceholder = document.getElementById('detailPanelPlaceholder');
            const detailPanelContent = document.getElementById('detailPanelContent');
            // Series Modal Elements
            const seriesModal = document.getElementById('seriesModal');
            const seriesModalTitle = document.getElementById('seriesModalTitle').querySelector('span'); // Target the span for text
            const seriesForm = document.getElementById('seriesForm');
            const cancelSeriesBtn = document.getElementById('cancelSeriesBtn');
            const closeSeriesModalBtn = document.getElementById('closeSeriesModalBtn');
            const editSeriesIndexInput = document.getElementById('editSeriesIndex'); // Hidden input
            const tituloSerieInput = document.getElementById('tituloSerie');
            const descripcionSerieInput = document.getElementById('descripcionSerie');
            const imagenSerieInput = document.getElementById('imagenSerie');
            // Episode Modal Elements
            const episodeModal = document.getElementById('episodeModal');
            const episodeModalTitle = document.getElementById('episodeModalTitle').querySelector('span'); // Target the span for text
            const episodeForm = document.getElementById('episodeForm');
            const cancelEpisodeBtn = document.getElementById('cancelEpisodeBtn');
            const closeEpisodeModalBtn = document.getElementById('closeEpisodeModalBtn');
            const editEpisodeSeriesIndexInput = document.getElementById('editEpisodeSeriesIndex'); // Hidden input
            const editEpisodeSeasonIndexInput = document.getElementById('editEpisodeSeasonIndex'); // Hidden input
            const editEpisodeIndexInput = document.getElementById('editEpisodeIndex'); // Hidden input
            const tituloEpisodioInput = document.getElementById('tituloEpisodio');
            const urlDriveEpisodioInput = document.getElementById('urlDriveEpisodio');

            // --- Constants ---
            const placeholderImage = "https://placehold.co/96x144/1f2937/9ca3af?text=IMG"; // Darker placeholder

            // --- Load Initial Data ---
            function loadInitialData() {
                const savedData = localStorage.getItem('seriesEditorData');
                if (savedData) {
                    try {
                        seriesData = JSON.parse(savedData);
                        if (!Array.isArray(seriesData)) {
                             console.warn("localStorage data is not an array, resetting.");
                             seriesData = [];
                        } else {
                             seriesData = seriesData.filter(item => item && typeof item === 'object' && typeof item.tituloSerie === 'string');
                        }
                        console.log(`LOG: Datos cargados desde localStorage (${seriesData.length} series).`);
                    } catch (e) {
                        console.error("Error al parsear datos de localStorage:", e);
                        seriesData = [];
                        localStorage.removeItem('seriesEditorData');
                    }
                } else {
                    console.log("LOG: No se encontraron datos en localStorage.");
                    seriesData = [];
                }
                renderSeriesList();
                updateDetailPanel();
            }

            // --- Save data to localStorage ---
            function saveData() {
                try {
                    localStorage.setItem('seriesEditorData', JSON.stringify(seriesData));
                } catch (e) {
                    console.error("Error al guardar datos en localStorage:", e);
                    alert("Advertencia: No se pudieron guardar los cambios en el almacenamiento local.");
                }
            }

            // --- Render Functions ---

            /** Renders the list of series in the left panel */
            function renderSeriesList() {
                const searchTerm = seriesSearchInput.value.toLowerCase().trim();
                seriesListDiv.innerHTML = ''; // Clear previous list

                const seriesToRender = seriesData
                    .map((serie, index) => ({ ...serie, originalIndex: index }))
                    .filter(serie => (serie.tituloSerie || '').toLowerCase().includes(searchTerm));

                if (seriesToRender.length === 0) {
                    // Use placeholder style from first version
                    seriesListDiv.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                             <i class="fas ${searchTerm ? 'fa-search' : 'fa-film'} text-4xl mb-3 opacity-30"></i>
                             <p>${searchTerm ? 'Ninguna serie coincide.' : 'No hay series cargadas.'}</p>
                             ${!searchTerm && seriesData.length === 0 ? `
                                <button id="addFirstSeriesBtnList" class="btn btn-primary mt-4 text-sm glow-effect">
                                     <i class="fas fa-plus mr-1"></i> Añadir primera serie
                                 </button>` : ''
                             }
                             ${searchTerm ? '<p class="text-sm mt-2">Intenta con otro término</p>' : ''}
                         </div>`;
                     // Add listener for the dynamic button
                     document.getElementById('addFirstSeriesBtnList')?.addEventListener('click', () => openSeriesModal());

                    if (selectedSeriesIndex !== null && !seriesToRender.some(s => s.originalIndex === selectedSeriesIndex)) {
                        selectedSeriesIndex = null;
                        selectedSeasonIndex = null;
                        updateDetailPanel();
                    }
                    return;
                }

                seriesToRender.forEach((serie) => {
                    const item = document.createElement('div');
                    // Apply style from first version
                    item.className = `series-list-item group glow-effect ${serie.originalIndex === selectedSeriesIndex ? 'selected' : ''}`;
                    item.dataset.originalIndex = serie.originalIndex;
                    item.tabIndex = 0;

                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = serie.tituloSerie || 'Serie Sin Título';
                    titleSpan.className = 'flex-grow truncate pr-2';
                    item.appendChild(titleSpan);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    // Apply style from first version
                    deleteBtn.className = 'btn btn-danger btn-icon delete-series-btn'; // Class controls visibility via CSS
                    deleteBtn.title = 'Eliminar Serie';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteSeries(serie.originalIndex);
                    };
                    item.appendChild(deleteBtn);

                    item.addEventListener('click', () => {
                         // Find current index in case array was modified
                         const currentIdx = seriesData.findIndex(s => s.tituloSerie === serie.tituloSerie); // Simple lookup
                         if (currentIdx !== -1 && selectedSeriesIndex !== currentIdx) {
                             selectedSeriesIndex = currentIdx;
                             selectedSeasonIndex = (seriesData[selectedSeriesIndex]?.temporadas?.length > 0) ? 0 : null; // Default to first season or null
                             renderSeriesList(); // Update selection style
                             updateDetailPanel();
                         } else if (currentIdx === -1) {
                             console.warn("Clicked series not found in current data:", serie.tituloSerie);
                         }
                    });
                    item.addEventListener('keydown', (e) => {
                         if (e.key === 'Enter' || e.key === ' ') {
                             e.preventDefault();
                             item.click();
                         } else if (e.key === 'Delete') {
                             e.preventDefault();
                             deleteSeries(serie.originalIndex);
                         }
                     });

                    seriesListDiv.appendChild(item);
                });
            }

            /** Updates the detail panel (right side) */
            function updateDetailPanel() {
                if (selectedSeriesIndex === null || selectedSeriesIndex >= seriesData.length || !seriesData[selectedSeriesIndex]) {
                    detailPanelPlaceholder.classList.remove('hidden');
                    detailPanelPlaceholder.style.display = 'flex'; // Ensure placeholder style applies
                    detailPanelContent.classList.add('hidden');
                    detailPanelContent.innerHTML = '';
                } else {
                    detailPanelPlaceholder.classList.add('hidden');
                    detailPanelPlaceholder.style.display = 'none';
                    detailPanelContent.classList.remove('hidden');
                    detailPanelContent.style.display = 'flex';
                    renderSelectedSeriesDetails();
                }
            }

            /** Renders the details for the currently selected series */
            function renderSelectedSeriesDetails() {
                 if (selectedSeriesIndex === null || !seriesData[selectedSeriesIndex]){
                     console.error("LOG: renderSelectedSeriesDetails called with invalid index or data.");
                     updateDetailPanel();
                     return;
                 }
                const serie = seriesData[selectedSeriesIndex];
                detailPanelContent.innerHTML = ''; // Clear previous

                // --- Header Section (like first version) ---
                const headerDiv = document.createElement('div');
                 headerDiv.className = 'flex flex-col md:flex-row gap-6 mb-6 pb-6 border-b border-gray-700 flex-shrink-0'; // Added border

                const img = document.createElement('img');
                img.src = serie.imagen || placeholderImage;
                img.alt = `Portada ${serie.tituloSerie || 'Serie'}`;
                 // Style like first version
                img.className = 'w-full md:w-48 h-auto md:h-64 object-cover rounded-lg shadow-md border border-gray-600';
                img.onerror = () => { img.src = placeholderImage; };
                headerDiv.appendChild(img);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex-1'; // Takes remaining space

                const titleEditDiv = document.createElement('div');
                titleEditDiv.className = 'flex justify-between items-start mb-2';

                const titleH2 = document.createElement('h2');
                 // Style like first version
                titleH2.className = 'text-2xl lg:text-3xl font-bold text-gray-100';
                titleH2.textContent = serie.tituloSerie || 'Serie Sin Título';
                titleEditDiv.appendChild(titleH2);

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                 // Style like first version
                editBtn.className = 'btn btn-secondary btn-icon glow-effect';
                editBtn.title = 'Editar Detalles de la Serie';
                editBtn.onclick = () => openSeriesModal(selectedSeriesIndex);
                titleEditDiv.appendChild(editBtn);

                infoDiv.appendChild(titleEditDiv);

                const descP = document.createElement('p');
                 // Style like first version
                descP.className = 'text-gray-300 text-sm leading-relaxed max-h-32 overflow-y-auto'; // Limit height and scroll
                descP.textContent = serie.descripcion || '<span class="italic text-gray-500">Sin descripción</span>'; // Italic placeholder
                infoDiv.appendChild(descP);

                headerDiv.appendChild(infoDiv);
                detailPanelContent.appendChild(headerDiv);

                // --- Seasons Section (like first version) ---
                const seasonsContainer = document.createElement('div');
                seasonsContainer.className = 'mb-6 flex-shrink-0'; // Added mb

                const seasonsHeader = document.createElement('div');
                seasonsHeader.className = 'flex justify-between items-center mb-4'; // Increased margin

                const seasonsTitle = document.createElement('h3');
                 // Style like first version
                seasonsTitle.className = 'text-xl font-semibold text-gray-200 flex items-center';
                seasonsTitle.innerHTML = '<i class="fas fa-layer-group mr-2 text-blue-400"></i> Temporadas'; // Added icon
                seasonsHeader.appendChild(seasonsTitle);

                const seasonActionsDiv = document.createElement('div');
                seasonActionsDiv.className = 'flex gap-2';

                const deleteSeasonBtnEl = document.createElement('button');
                deleteSeasonBtnEl.innerHTML = '<i class="fas fa-trash"></i>';
                 // Style like first version
                deleteSeasonBtnEl.className = 'btn btn-danger btn-icon glow-effect';
                deleteSeasonBtnEl.title = 'Eliminar Temporada Seleccionada';
                deleteSeasonBtnEl.onclick = () => {
                    if (selectedSeriesIndex !== null && selectedSeasonIndex !== null) {
                        deleteSeason(selectedSeriesIndex, selectedSeasonIndex);
                    }
                };
                 const hasSeasons = serie.temporadas && Array.isArray(serie.temporadas) && serie.temporadas.length > 0;
                 deleteSeasonBtnEl.disabled = !hasSeasons || selectedSeasonIndex === null;
                seasonActionsDiv.appendChild(deleteSeasonBtnEl);

                const addSeasonBtnEl = document.createElement('button');
                addSeasonBtnEl.innerHTML = '<i class="fas fa-plus"></i>';
                 // Style like first version
                addSeasonBtnEl.className = 'btn btn-primary btn-icon glow-effect'; // Changed color
                addSeasonBtnEl.title = 'Añadir Nueva Temporada';
                addSeasonBtnEl.onclick = () => addSeason(selectedSeriesIndex);
                seasonActionsDiv.appendChild(addSeasonBtnEl);

                seasonsHeader.appendChild(seasonActionsDiv);
                seasonsContainer.appendChild(seasonsHeader);

                const seasonTabsDiv = document.createElement('div');
                 // Style like first version
                seasonTabsDiv.className = 'flex flex-wrap gap-2 mb-4 border-b border-gray-700 pb-4'; // Added border/padding
                seasonsContainer.appendChild(seasonTabsDiv);
                detailPanelContent.appendChild(seasonsContainer);

                // --- Episodes Section (like first version) ---
                const episodesOuterContainer = document.createElement('div');
                episodesOuterContainer.className = 'flex-grow flex flex-col overflow-hidden'; // Takes remaining space

                const episodesHeader = document.createElement('div');
                episodesHeader.className = 'flex justify-between items-center mb-4'; // Increased margin

                const episodesTitle = document.createElement('h3'); // Changed to H3
                episodesTitle.id = 'dynamicEpisodeListTitle';
                 // Style like first version
                episodesTitle.className = 'text-xl font-semibold text-gray-200 flex items-center';
                episodesTitle.innerHTML = '<i class="fas fa-list-ol mr-2 text-blue-400"></i> Episodios'; // Added icon
                episodesHeader.appendChild(episodesTitle);

                const addEpisodeBtnEl = document.createElement('button');
                addEpisodeBtnEl.innerHTML = '<i class="fas fa-plus"></i>';
                 // Style like first version
                addEpisodeBtnEl.className = 'btn btn-primary btn-icon glow-effect';
                addEpisodeBtnEl.title = 'Añadir Episodio a esta Temporada';
                addEpisodeBtnEl.id = 'addEpisodeBtnDetail';
                addEpisodeBtnEl.onclick = () => {
                    if (selectedSeriesIndex !== null && selectedSeasonIndex !== null) {
                        openEpisodeModal(selectedSeriesIndex, selectedSeasonIndex);
                    } else {
                        alert("Por favor, selecciona o añade una temporada primero.");
                    }
                };
                addEpisodeBtnEl.disabled = selectedSeasonIndex === null || !hasSeasons;
                episodesHeader.appendChild(addEpisodeBtnEl);
                episodesOuterContainer.appendChild(episodesHeader);

                // Episode search - keep simple for now or restyle later if needed
                const episodeSearchDiv = document.createElement('div');
                episodeSearchDiv.className = 'mb-3 flex-shrink-0';
                const episodeSearch = document.createElement('input');
                episodeSearch.type = 'search';
                episodeSearch.id = 'episodeSearchInputDetail';
                episodeSearch.className = 'search-input text-sm'; // Use standard search input style
                episodeSearch.placeholder = 'Buscar episodio por título...';
                episodeSearch.addEventListener('input', () => {
                    if (selectedSeriesIndex !== null && selectedSeasonIndex !== null) {
                        const currentEpisodes = seriesData[selectedSeriesIndex]?.temporadas?.[selectedSeasonIndex]?.episodios || [];
                        renderEpisodeList(currentEpisodes, episodeSearch.value);
                    }
                });
                episodeSearchDiv.appendChild(episodeSearch);
                episodesOuterContainer.appendChild(episodeSearchDiv);

                const episodeListContainer = document.createElement('div'); // Container for list itself
                episodeListContainer.id = 'detailEpisodeListContainer';
                 // Style like first version
                episodeListContainer.className = 'space-y-2 flex-grow overflow-y-auto pr-1'; // Use space-y, scroll
                episodeListContainer.tabIndex = -1;
                episodesOuterContainer.appendChild(episodeListContainer);
                detailPanelContent.appendChild(episodesOuterContainer);

                // --- Render Season Tabs & Initial Episodes ---
                if (!hasSeasons) {
                    seasonTabsDiv.innerHTML = '<p class="text-sm text-gray-500 italic w-full">No hay temporadas. Añade una.</p>'; // Adjusted text
                    renderEpisodeList([], '');
                } else {
                    serie.temporadas.sort((a, b) => (a.numeroTemporada ?? Infinity) - (b.numeroTemporada ?? Infinity));
                    if (selectedSeasonIndex === null || selectedSeasonIndex >= serie.temporadas.length) {
                        selectedSeasonIndex = 0;
                    }

                    serie.temporadas.forEach((season, index) => {
                        const tab = document.createElement('button');
                         // Apply style from first version
                        tab.className = `season-tab ${index === selectedSeasonIndex ? 'active' : ''}`;
                        tab.textContent = `T${season.numeroTemporada !== undefined && season.numeroTemporada !== null ? season.numeroTemporada : index + 1}`;
                        tab.dataset.seasonIndex = index;
                        tab.tabIndex = 0;

                        tab.addEventListener('click', () => {
                            if (selectedSeasonIndex !== index) {
                                selectedSeasonIndex = index;
                                episodeSearch.value = '';
                                renderSelectedSeriesDetails();
                                setTimeout(() => focusFirstElement(episodeListContainer.querySelector('.episode-list-entry, button, input')), 100);
                            }
                        });
                         tab.addEventListener('keydown', (e) => {
                             if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); tab.click(); }
                             // Add Arrow key navigation if desired
                         });
                        seasonTabsDiv.appendChild(tab);
                    });

                    if (selectedSeasonIndex !== null && serie.temporadas[selectedSeasonIndex]) {
                        // Update episode title text after tabs are rendered
                        const seasonNumText = serie.temporadas[selectedSeasonIndex].numeroTemporada !== undefined ? serie.temporadas[selectedSeasonIndex].numeroTemporada : selectedSeasonIndex + 1;
                        episodesTitle.innerHTML = `<i class="fas fa-list-ol mr-2 text-blue-400"></i> Episodios (T${seasonNumText})`;
                        renderEpisodeList(serie.temporadas[selectedSeasonIndex].episodios || [], '');
                    } else {
                         episodesTitle.innerHTML = `<i class="fas fa-list-ol mr-2 text-blue-400"></i> Episodios`;
                        renderEpisodeList([], '');
                    }
                }
            }

            /** Renders the list of episodes for the selected season */
            function renderEpisodeList(episodesArray, searchTerm) {
                const episodeListContainer = document.getElementById('detailEpisodeListContainer'); // Target the container div
                const addEpBtnEl = document.getElementById('addEpisodeBtnDetail');

                if (!episodeListContainer) {
                    console.error("LOG: Cannot find episode list container for rendering.");
                    return;
                }

                const searchTermLower = searchTerm.toLowerCase().trim();
                episodeListContainer.innerHTML = ''; // Clear previous episode list

                if (!episodesArray || !Array.isArray(episodesArray)) {
                    console.warn("LOG: Invalid or missing episodes array for season index", selectedSeasonIndex);
                    episodeListContainer.innerHTML = '<p class="text-sm text-gray-400 italic p-2">Error: Datos de episodios inválidos.</p>';
                    if(addEpBtnEl) addEpBtnEl.disabled = selectedSeasonIndex === null;
                    return;
                }

                const filteredEpisodes = episodesArray
                    .map((episode, index) => ({ ...episode, originalIndex: index }))
                    .filter(episode => (episode.tituloEpisodio || '').toLowerCase().includes(searchTermLower));

                if (filteredEpisodes.length === 0) {
                    episodeListContainer.innerHTML = `<p class="text-sm text-gray-400 italic p-2">${searchTermLower ? 'Ningún episodio coincide.' : 'No hay episodios. Añade uno.'}</p>`; // Adjusted text
                    if(addEpBtnEl) addEpBtnEl.disabled = selectedSeasonIndex === null;
                    return;
                }

                if(addEpBtnEl) addEpBtnEl.disabled = false;

                filteredEpisodes.forEach((episode) => {
                    const entryDiv = document.createElement('div');
                    // Apply style from first version
                    entryDiv.className = 'episode-list-entry group glow-effect'; // Use div instead of li
                    entryDiv.tabIndex = 0;
                    entryDiv.dataset.originalIndex = episode.originalIndex;

                    const textSpan = document.createElement('span');
                    const episodeTitleText = episode.tituloEpisodio || `Episodio ${episode.originalIndex + 1}`;
                    // Style like first version
                    textSpan.innerHTML = `<strong class="mr-2">${episode.originalIndex + 1}.</strong> ${episodeTitleText}`; // Add number
                    textSpan.title = episodeTitleText;
                    textSpan.className = 'truncate flex-grow text-sm'; // Added text-sm
                    entryDiv.appendChild(textSpan);

                    const actionsDiv = document.createElement('div');
                     // Apply style from first version
                    actionsDiv.className = 'episode-actions flex gap-1 flex-shrink-0';

                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                     // Apply style from first version
                    editBtn.className = 'btn btn-secondary btn-icon text-xs';
                    editBtn.title = 'Editar Episodio';
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        openEpisodeModal(selectedSeriesIndex, selectedSeasonIndex, episode.originalIndex);
                    };
                    actionsDiv.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                     // Apply style from first version
                    deleteBtn.className = 'btn btn-danger btn-icon text-xs';
                    deleteBtn.title = 'Eliminar Episodio';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteEpisode(selectedSeriesIndex, selectedSeasonIndex, episode.originalIndex);
                    };
                    actionsDiv.appendChild(deleteBtn);

                    entryDiv.appendChild(actionsDiv);

                     entryDiv.addEventListener('click', () => {
                         console.log(`Clicked episode: ${episodeTitleText}`);
                         entryDiv.focus();
                     });
                     entryDiv.addEventListener('keydown', (e) => {
                         handleEpisodeKeydown(e, entryDiv, episode);
                     });

                    episodeListContainer.appendChild(entryDiv); // Append to container div
                });
            }

             /** Handles keydown events on episode list items */
            function handleEpisodeKeydown(e, listItem, episode) {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     console.log(`Enter/Space on episode: ${episode.tituloEpisodio}`);
                 } else if (e.key === 'Delete') {
                     e.preventDefault();
                     const delButton = listItem.querySelector('.btn-danger');
                     if (delButton) delButton.click();
                 } else if (e.key === 'e' || e.key === 'E') {
                     e.preventDefault();
                     const editButton = listItem.querySelector('.btn-secondary');
                     if (editButton) editButton.click();
                 } else if (e.key === 'ArrowDown') {
                     e.preventDefault();
                     const nextLi = listItem.nextElementSibling;
                     if (nextLi) nextLi.focus();
                 } else if (e.key === 'ArrowUp') {
                     e.preventDefault();
                     const prevLi = listItem.previousElementSibling;
                     if (prevLi) prevLi.focus();
                 }
             }


            /** Focuses the first focusable element within a given container */
            function focusFirstElement(element) {
                if (element && typeof element.focus === 'function') {
                    element.focus();
                }
            }

            // --- Modal Handling --- (Using restyled modals)

            /** Opens the Series Add/Edit modal */
            function openSeriesModal(index = null) {
                seriesForm.reset();
                editingSeriesIndex = index;

                if (index !== null && seriesData[index]) {
                    seriesModalTitle.textContent = 'Editar Serie'; // Target span
                    editSeriesIndexInput.value = index;
                    tituloSerieInput.value = seriesData[index].tituloSerie || '';
                    descripcionSerieInput.value = seriesData[index].descripcion || '';
                    imagenSerieInput.value = seriesData[index].imagen || '';
                } else {
                    seriesModalTitle.textContent = 'Añadir Nueva Serie'; // Target span
                    editSeriesIndexInput.value = '';
                }
                seriesModal.classList.remove('hidden');
                seriesModal.classList.add('flex');
                tituloSerieInput.focus();
            }

            /** Closes the Series modal */
            function closeSeriesModal() {
                seriesModal.classList.add('hidden');
                seriesModal.classList.remove('flex');
                editingSeriesIndex = null;
            }

            /** Opens the Episode Add/Edit modal */
            function openEpisodeModal(seriesIdx, seasonIdx, episodeIdx = null) {
                if (seriesIdx === null || seasonIdx === null || !seriesData[seriesIdx]?.temporadas?.[seasonIdx]) {
                    alert("Error interno: No se pudo determinar la serie o temporada.");
                    return;
                }

                episodeForm.reset();
                editingEpisodeInfo = { seriesIndex: seriesIdx, seasonIndex: seasonIdx, episodeIndex: episodeIdx };

                const season = seriesData[seriesIdx].temporadas[seasonIdx];
                const seasonNum = season.numeroTemporada !== undefined ? season.numeroTemporada : seasonIdx + 1;

                if (episodeIdx !== null && season?.episodios?.[episodeIdx]) {
                    const ep = season.episodios[episodeIdx];
                    episodeModalTitle.textContent = `Editar Episodio (T${seasonNum})`; // Target span
                    tituloEpisodioInput.value = ep.tituloEpisodio || '';
                    urlDriveEpisodioInput.value = ep.urlDrive || '';
                } else {
                    episodeModalTitle.textContent = `Añadir Episodio a T${seasonNum}`; // Target span
                }

                editEpisodeSeriesIndexInput.value = seriesIdx;
                editEpisodeSeasonIndexInput.value = seasonIdx;
                editEpisodeIndexInput.value = episodeIdx !== null ? episodeIdx : '';

                episodeModal.classList.remove('hidden');
                episodeModal.classList.add('flex');
                tituloEpisodioInput.focus();
            }

             /** Closes the Episode modal */
            function closeEpisodeModal() {
                episodeModal.classList.add('hidden');
                episodeModal.classList.remove('flex');
                editingEpisodeInfo = null;
            }

            // --- Event Listeners ---

            // Open Modals
            addSeriesBtn.addEventListener('click', () => openSeriesModal());

            // Close Modals
            cancelSeriesBtn.addEventListener('click', closeSeriesModal);
            closeSeriesModalBtn.addEventListener('click', closeSeriesModal);
            cancelEpisodeBtn.addEventListener('click', closeEpisodeModal);
            closeEpisodeModalBtn.addEventListener('click', closeEpisodeModal);
            seriesModal.addEventListener('click', (e) => {
                 // Use modal content ID added in HTML
                 const content = seriesModal.querySelector('.bg-gray-800'); // Find content div
                 if (content && !content.contains(e.target)) closeSeriesModal();
            });
            episodeModal.addEventListener('click', (e) => {
                 // Use modal content ID added in HTML
                 const content = episodeModal.querySelector('.bg-gray-800'); // Find content div
                 if (content && !content.contains(e.target)) closeEpisodeModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!seriesModal.classList.contains('hidden')) closeSeriesModal();
                    if (!episodeModal.classList.contains('hidden')) closeEpisodeModal();
                }
            });

            // Form Submissions
            seriesForm.addEventListener('submit', handleSeriesFormSubmit);
            episodeForm.addEventListener('submit', handleEpisodeFormSubmit);

            // File/Text Loading
            loadJsonFileInput.addEventListener('change', handleFileLoad);
            loadFromJsonTextBtn.addEventListener('click', handleTextLoad);

            // Search Input
            seriesSearchInput.addEventListener('input', renderSeriesList);

            // JSON Download
            generateJsonBtn.addEventListener('click', handleJsonDownload);

            // --- Form Submit Handlers ---
            function handleSeriesFormSubmit(e) {
                e.preventDefault();
                const seriesDataObj = {
                    tituloSerie: tituloSerieInput.value.trim(),
                    descripcion: descripcionSerieInput.value.trim(),
                    imagen: imagenSerieInput.value.trim() || '',
                    temporadas: editingSeriesIndex !== null && seriesData[editingSeriesIndex]
                                ? (seriesData[editingSeriesIndex].temporadas || [])
                                : []
                };

                if (!seriesDataObj.tituloSerie) {
                     alert("El título de la serie es obligatorio.");
                     tituloSerieInput.focus();
                     return;
                }


                if (editingSeriesIndex !== null) {
                    updateSeries(editingSeriesIndex, seriesDataObj);
                } else {
                    addSeries(seriesDataObj);
                    selectedSeriesIndex = seriesData.length - 1;
                    selectedSeasonIndex = null;
                }
                closeSeriesModal();
                renderSeriesList();
                updateDetailPanel();
            }

            function handleEpisodeFormSubmit(e) {
                e.preventDefault();
                if (!editingEpisodeInfo) {
                    console.error("Error: No editing context found for episode form submission.");
                    closeEpisodeModal();
                    return;
                }
                const { seriesIndex, seasonIndex, episodeIndex } = editingEpisodeInfo;
                const urlValue = urlDriveEpisodioInput.value.trim();
                const titleValue = tituloEpisodioInput.value.trim(); // Get title

                 if (!titleValue) { // Validate title
                     alert("El título del episodio es obligatorio.");
                     tituloEpisodioInput.focus();
                     return;
                 }

                if (!urlValue || !(urlValue.startsWith('http://') || urlValue.startsWith('https://'))) {
                    alert("La URL del Video no es válida. Debe empezar con 'http://' o 'https://'.");
                    urlDriveEpisodioInput.focus();
                    return;
                }

                const episodeDataObj = {
                    tituloEpisodio: titleValue, // Use validated title
                    urlDrive: urlValue
                };

                if (episodeIndex !== null) {
                    updateEpisode(seriesIndex, seasonIndex, episodeIndex, episodeDataObj);
                } else {
                    addEpisode(seriesIndex, seasonIndex, episodeDataObj);
                }
                closeEpisodeModal();
                if (seriesIndex === selectedSeriesIndex) {
                    updateDetailPanel();
                }
            }

            // --- Load/Save Handlers ---
            function handleFileLoad(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (!file.name.toLowerCase().endsWith('.json')) {
                    alert("Por favor, selecciona un archivo con extensión .json.");
                    event.target.value = null;
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    try {
                        const parsedData = JSON.parse(content);
                        if (!Array.isArray(parsedData)) {
                            throw new Error("El contenido del archivo JSON no es un array válido.");
                        }
                        seriesData = parsedData;
                        selectedSeriesIndex = null;
                        selectedSeasonIndex = null;
                        seriesSearchInput.value = '';
                        renderSeriesList();
                        updateDetailPanel();
                        saveData();
                        alert("¡Archivo JSON cargado y guardado localmente!");
                        pasteJsonArea.value = '';
                    } catch (error) {
                        console.error("Error parsing JSON from file:", error);
                        alert(`Error al cargar el archivo JSON: ${error.message}`);
                    } finally {
                        event.target.value = null;
                    }
                };
                reader.onerror = () => {
                    alert("Error al leer el archivo.");
                    event.target.value = null;
                };
                reader.readAsText(file);
            }

            function handleTextLoad() {
                const jsonText = pasteJsonArea.value.trim();
                if (!jsonText) {
                    alert("Por favor, pega el contenido JSON en el área de texto.");
                    pasteJsonArea.focus();
                    return;
                }
                try {
                    const parsedData = JSON.parse(jsonText);
                    if (!Array.isArray(parsedData)) {
                        throw new Error("El texto pegado no es un array JSON válido.");
                    }
                    seriesData = parsedData;
                    selectedSeriesIndex = null;
                    selectedSeasonIndex = null;
                    seriesSearchInput.value = '';
                    renderSeriesList();
                    updateDetailPanel();
                    saveData();
                    alert("¡JSON cargado desde el texto y guardado localmente!");
                } catch (error) {
                    console.error("Error parsing JSON from text:", error);
                    alert(`Error al cargar desde el texto JSON: ${error.message}`);
                }
            }

            function handleJsonDownload() {
                 if (seriesData.length === 0) {
                     alert("No hay datos de series para descargar.");
                     return;
                 }
                 try {
                     const jsonString = JSON.stringify(seriesData, null, 2);
                     const blob = new Blob([jsonString], { type: 'application/json' });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = 'playlist_series.json';
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                     URL.revokeObjectURL(url);
                     console.log("LOG: Generated and triggered download for playlist.json");
                 } catch (error) {
                     console.error("Error generating or downloading JSON:", error);
                     alert("Ocurrió un error al generar el archivo JSON.");
                 }
             }


            // --- CRUD Operations ---

            /** Adds a new series object */
            function addSeries(newSeries) {
                if (!newSeries.temporadas) newSeries.temporadas = [];
                seriesData.push(newSeries);
                saveData();
                console.log("LOG: Added series:", newSeries.tituloSerie);
            }

            /** Updates an existing series */
            function updateSeries(index, updatedSeriesData) {
                if (index >= 0 && index < seriesData.length) {
                    seriesData[index] = updatedSeriesData;
                    saveData();
                    console.log("LOG: Updated series:", updatedSeriesData.tituloSerie);
                } else {
                    console.error("Error: Invalid index for updateSeries:", index);
                }
            }

            /** Deletes a series */
            function deleteSeries(index) {
                 // Find the actual current index based on originalIndex, as the array might have changed
                 const currentIndex = seriesData.findIndex((s, i) => i === index); // If originalIndex is reliable enough
                 // Or find by a unique property if titles aren't unique:
                 // const currentSerie = seriesData.find((s, i) => i === index);
                 // const currentIndex = seriesData.findIndex(s => s.id === currentSerie?.id); // Assuming an ID exists

                 if (currentIndex >= 0 && currentIndex < seriesData.length) {
                    const seriesTitle = seriesData[currentIndex].tituloSerie || 'esta serie sin título';
                    if (confirm(`¿Estás seguro de que quieres eliminar "${seriesTitle}" y todo su contenido?`)) {
                        seriesData.splice(currentIndex, 1);
                        saveData();
                        console.log("LOG: Deleted series at actual index:", currentIndex);
                        if (selectedSeriesIndex === currentIndex) {
                            selectedSeriesIndex = null;
                            selectedSeasonIndex = null;
                            updateDetailPanel();
                        } else if (selectedSeriesIndex !== null && selectedSeriesIndex > currentIndex) {
                            selectedSeriesIndex--;
                        }
                        renderSeriesList();
                    }
                } else {
                    console.error("Error: Invalid index for deleteSeries:", index, "or series not found.");
                }
            }


            /** Adds a new season */
            function addSeason(seriesIndex) {
                if (seriesIndex >= 0 && seriesIndex < seriesData.length) {
                    const serie = seriesData[seriesIndex];
                    if (!serie.temporadas || !Array.isArray(serie.temporadas)) serie.temporadas = [];
                    const existingSeasonNumbers = serie.temporadas.map(s => s.numeroTemporada).filter(n => typeof n === 'number' && !isNaN(n));
                    const nextSeasonNum = existingSeasonNumbers.length > 0 ? Math.max(0, ...existingSeasonNumbers) + 1 : 1;
                    serie.temporadas.push({ numeroTemporada: nextSeasonNum, episodios: [] });
                    saveData();
                    console.log(`LOG: Added season ${nextSeasonNum} to series index ${seriesIndex}`);
                    selectedSeasonIndex = serie.temporadas.length - 1;
                    updateDetailPanel();
                } else {
                    console.error("Error: Invalid series index for addSeason:", seriesIndex);
                }
            }

            /** Deletes a season */
            function deleteSeason(seriesIndex, seasonIndex) {
                 if (seriesIndex >= 0 && seriesIndex < seriesData.length) {
                     const serie = seriesData[seriesIndex];
                     if (serie.temporadas && Array.isArray(serie.temporadas) && seasonIndex >= 0 && seasonIndex < serie.temporadas.length) {
                         const seasonNum = serie.temporadas[seasonIndex].numeroTemporada !== undefined ? serie.temporadas[seasonIndex].numeroTemporada : seasonIndex + 1;
                         if (confirm(`¿Estás seguro de que quieres eliminar la Temporada ${seasonNum} y todos sus episodios?`)) {
                             serie.temporadas.splice(seasonIndex, 1);
                             saveData();
                             console.log(`LOG: Deleted season index ${seasonIndex} from series index ${seriesIndex}`);
                             if (selectedSeasonIndex === seasonIndex) {
                                 selectedSeasonIndex = serie.temporadas.length > 0 ? Math.max(0, seasonIndex - 1) : null;
                             } else if (selectedSeasonIndex !== null && selectedSeasonIndex > seasonIndex) {
                                 selectedSeasonIndex--;
                             }
                              // Ensure selected index is valid after deletion
                             if (selectedSeasonIndex !== null && selectedSeasonIndex >= serie.temporadas.length) {
                                selectedSeasonIndex = Math.max(0, serie.temporadas.length - 1);
                             }
                             updateDetailPanel();
                         }
                     } else {
                         console.error("Error: Invalid season index or data for deleteSeason:", seasonIndex);
                     }
                 } else {
                     console.error("Error: Invalid series index for deleteSeason:", seriesIndex);
                 }
             }


            /** Adds a new episode */
            function addEpisode(seriesIndex, seasonIndex, newEpisode) {
                 if (seriesIndex >= 0 && seriesIndex < seriesData.length) {
                     const serie = seriesData[seriesIndex];
                     if (serie.temporadas && Array.isArray(serie.temporadas) && seasonIndex >= 0 && seasonIndex < serie.temporadas.length) {
                         const season = serie.temporadas[seasonIndex];
                         if (!season.episodios || !Array.isArray(season.episodios)) season.episodios = [];
                         season.episodios.push(newEpisode);
                         saveData();
                         console.log(`LOG: Added episode "${newEpisode.tituloEpisodio}" to S${seasonIndex} of series ${seriesIndex}`);
                     } else {
                         console.error("Error: Invalid season index or data for addEpisode:", seasonIndex);
                     }
                 } else {
                     console.error("Error: Invalid series index for addEpisode:", seriesIndex);
                 }
             }

            /** Updates an existing episode */
            function updateEpisode(seriesIndex, seasonIndex, episodeIndex, updatedEpisode) {
                  if (seriesIndex >= 0 && seriesIndex < seriesData.length) {
                      const serie = seriesData[seriesIndex];
                      if (serie.temporadas && Array.isArray(serie.temporadas) && seasonIndex >= 0 && seasonIndex < serie.temporadas.length) {
                          const season = serie.temporadas[seasonIndex];
                          if (season.episodios && Array.isArray(season.episodios) && episodeIndex >= 0 && episodeIndex < season.episodios.length) {
                              season.episodios[episodeIndex] = updatedEpisode;
                              saveData();
                              console.log(`LOG: Updated episode index ${episodeIndex} in S${seasonIndex} of series ${seriesIndex}`);
                          } else {
                              console.error("Error: Invalid episode index or data for updateEpisode:", episodeIndex);
                          }
                      } else {
                          console.error("Error: Invalid season index or data for updateEpisode:", seasonIndex);
                      }
                  } else {
                      console.error("Error: Invalid series index for updateEpisode:", seriesIndex);
                  }
              }

            /** Deletes an episode */
            function deleteEpisode(seriesIndex, seasonIndex, episodeIndex) {
                   if (seriesIndex >= 0 && seriesIndex < seriesData.length) {
                       const serie = seriesData[seriesIndex];
                       if (serie.temporadas && Array.isArray(serie.temporadas) && seasonIndex >= 0 && seasonIndex < serie.temporadas.length) {
                           const season = serie.temporadas[seasonIndex];
                           if (season.episodios && Array.isArray(season.episodios) && episodeIndex >= 0 && episodeIndex < season.episodios.length) {
                               const episodeTitle = season.episodios[episodeIndex].tituloEpisodio || `este episodio (${episodeIndex + 1})`;
                               if (confirm(`¿Estás seguro de que quieres eliminar "${episodeTitle}"?`)) {
                                   season.episodios.splice(episodeIndex, 1);
                                   saveData();
                                   console.log(`LOG: Deleted episode index ${episodeIndex} from S${seasonIndex} of series ${seriesIndex}`);
                                   updateDetailPanel(); // Refresh detail panel
                               }
                           } else {
                               console.error("Error: Invalid episode index or data for deleteEpisode:", episodeIndex);
                           }
                       } else {
                           console.error("Error: Invalid season index or data for deleteEpisode:", seasonIndex);
                       }
                   } else {
                       console.error("Error: Invalid series index for deleteEpisode:", seriesIndex);
                   }
               }


            // --- Initial Load Call ---
            loadInitialData();
            console.log('LOG: Initial load sequence complete.');

        }); // End DOMContentLoaded
    </script>

</body>
</html>
